<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Nhật Ký Ăn Uống</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-100 font-sans">
  <!-- Header mới -->
  <header class="flex items-center justify-between px-8 py-4 bg-gradient-to-r from-blue-500 via-green-400 to-yellow-300 shadow-lg sticky top-0 z-40">
    <div class="flex items-center gap-4">
      <img src="/static/logo.png" class="w-12 h-12 rounded-full border-4 border-white shadow" alt="Logo" />
      <span class="text-3xl font-extrabold text-white tracking-wide flex items-center gap-2">
        <span></span> SmartCalories
      </span>
    </div>
    <div class="flex items-center gap-4">
      <span class="text-white font-semibold text-lg flex items-center gap-2">
        <span>👤</span> {{ fullname }}
      </span>
      <a href="/logout" class="bg-white/20 hover:bg-white/40 text-white px-4 py-2 rounded-xl font-bold shadow transition flex items-center gap-2">
        <span>🚪</span> Đăng xuất
      </a>
    </div>
  </header>
  <!-- Dashboard layout -->
  <main class="flex h-[calc(100vh-80px)] transition-all duration-300 ease-in-out">
    <!-- Sidebar -->
<aside class="w-64 bg-gradient-to-b from-blue-700 via-blue-500 to-blue-400 text-white p-4 space-y-2 shadow-lg">
  <nav class="flex flex-col gap-1">
    <button onclick="switchView('meals')" id="btn-meals"
      class="flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-blue-600 transition-all duration-200 font-medium focus:outline-none">
      📋 <span>Danh sách món</span>
    </button>
    <button onclick="switchView('log')" id="btn-log"
      class="flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-blue-600 transition-all duration-200 font-medium focus:outline-none">
      📖 <span>Nhật ký & Phân tích</span>
    </button>
    <button onclick="openLogMealModal()"
      class="flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-blue-600 transition-all duration-200 font-medium focus:outline-none">
      📝 <span>Ghi nhật ký</span>
    </button>
    <button onclick="openAddMealModal()"
      class="flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-blue-600 transition-all duration-200 font-medium focus:outline-none">
      ➕ <span>Thêm món</span>
    </button>
    <a href="/export-csv"
      class="flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-blue-600 transition-all duration-200 font-medium focus:outline-none">
      📤 <span>Xuất CSV</span>
    </a>
  </nav>
</aside>



    <!-- Content Area -->
    <section class="flex-1 overflow-y-auto p-6">
      <!-- Meals View -->
      <div id="mealsView" class="hidden">
        <h2 class="text-2xl font-bold mb-4">📋 Danh sách món ăn</h2>
          <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
            {% for meal in meals %}
            <div class="bg-white p-4 rounded-xl shadow">
  {% if meal.image_url %}
    <img src="{{ meal.image_url }}" alt="{{ meal.name }}" class="w-full h-40 object-cover rounded-lg mb-3" />
  {% else %}
    <div class="w-full h-40 bg-gray-200 rounded-lg flex items-center justify-center mb-3 text-gray-500">Không có ảnh</div>
  {% endif %}
  <h3 class="text-lg font-semibold">{{ meal.name }}</h3>
  <ul class="text-sm mt-2 text-gray-600">
    <li>🔥 Calories: {{ meal.calories }}</li>
    <li>💪 Protein: {{ meal.protein }}g</li>
    <li>🍞 Carbs: {{ meal.carbs }}g</li>
    <li>🥑 Fat: {{ meal.fat }}g</li>
  </ul>
  <div class="mt-4 flex gap-3">
    <button class="editMealBtn text-blue-600" data-meal='{{ meal | tojson }}'>✏️ Sửa</button>
    <button onclick="openModal('{{ meal._id }}')" class="text-red-600">🗑️ Xoá</button>
  </div>
</div>
            {% endfor %}
          </div>
        </div>

        <!-- Logs and Analytics View -->
        <div id="logView" class="hidden">
          <h2 class="text-2xl font-bold mb-4">🗓️ Nhật ký hôm nay</h2>
          <div class="bg-white rounded-xl shadow overflow-x-auto">
            <table class="min-w-full text-sm">
              <thead class="bg-gray-100">
                <tr>
                  <th class="p-3 text-left">Món</th>
                  <th class="p-3 text-left">Số lượng</th>
                  <th class="p-3 text-left">Calories</th>
                  <th class="p-3 text-left">Protein</th>
                  <th class="p-3 text-left">Carbs</th>
                  <th class="p-3 text-left">Fat</th>
                </tr>
              </thead>
              <tbody>
                {% for log in logs %}
                <tr class="even:bg-gray-50">
                  <td class="p-3">{{ log.meal.name }}</td>
                  <td class="p-3">{{ log.quantity }}</td>
                  <td class="p-3">{{ log.meal.calories * log.quantity }}</td>
                  <td class="p-3">{{ log.meal.protein * log.quantity }}</td>
                  <td class="p-3">{{ log.meal.carbs * log.quantity }}</td>
                  <td class="p-3">{{ log.meal.fat * log.quantity }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>

          <h2 class="text-2xl font-bold mt-10 mb-4">📊 Phân tích hôm nay</h2>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="bg-white p-6 rounded-xl shadow">
              <h3 class="text-lg font-semibold mb-2">📈 Dinh dưỡng tổng</h3>
              <canvas id="nutritionChart"></canvas>
            </div>
            <div class="bg-white p-6 rounded-xl shadow">
              <h3 class="text-lg font-semibold mb-2">🥗 Phân bố chất</h3>
              <canvas id="macroPieChart"></canvas>
            </div>
          </div>
        </div>
      </section>
    </main>

    <!-- JS Script -->
    <script>
      const summary = {
        calories: {{ summary.total_calories | default(0) }},
        protein: {{ summary.total_protein | default(0) }},
        carbs: {{ summary.total_carbs | default(0) }},
        fat: {{ summary.total_fat | default(0) }},
      };

      function switchView(view) {
        document.getElementById("mealsView").classList.add("hidden");
        document.getElementById("logView").classList.add("hidden");
        document.getElementById(view + "View").classList.remove("hidden");
      }

      window.onload = () => switchView('meals');

      new Chart(document.getElementById("nutritionChart"), {
        type: 'bar',
        data: {
          labels: ['Calories', 'Protein', 'Carbs', 'Fat'],
          datasets: [{
            label: 'Dinh dưỡng hôm nay',
            data: [summary.calories, summary.protein, summary.carbs, summary.fat],
            backgroundColor: ['#f87171', '#60a5fa', '#facc15', '#34d399']
          }]
        },
        options: {
          scales: {
            y: { beginAtZero: true }
          }
        }
      });

      new Chart(document.getElementById("macroPieChart"), {
        type: 'pie',
        data: {
          labels: ['Protein', 'Carbs', 'Fat'],
          datasets: [{
            data: [summary.protein, summary.carbs, summary.fat],
            backgroundColor: ['#60a5fa', '#facc15', '#34d399']
          }]
        },
        options: {
          plugins: {
            tooltip: {
              callbacks: {
                label: function (ctx) {
                  const total = ctx.dataset.data.reduce((a, b) => a + b, 0);
                  const value = ctx.parsed;
                  const percent = ((value / total) * 100).toFixed(1);
                  return `${ctx.label}: ${value}g (${percent}%)`;
                }
              }
            }
          }
        }
      });
    </script>
    <!-- Modal Ghi Nhật Ký -->
  <div id="logMealModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 hidden transition-opacity duration-300 ease-in-out">
    <div class="bg-white p-6 rounded-2xl shadow-lg w-full max-w-md space-y-4">
      <h2 class="text-2xl font-bold text-green-600 flex items-center gap-2">
        <span>📝</span> Ghi nhật ký
      </h2>
      <form action="/log-meal" method="POST" class="space-y-3">
        <select name="meal_id" class="w-full border border-gray-300 p-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-400 transition" required>
          {% for meal in meals %}
          <option value="{{ meal._id }}">{{ meal.name }}</option>
          {% endfor %}
        </select>
        <input name="quantity" type="number" placeholder="Số lượng" class="w-full border border-gray-300 p-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-400 transition" required>
        <input name="date" type="date" value="{{ today }}" class="w-full border border-gray-300 p-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-400 transition" required>
        <div class="flex justify-end gap-3 pt-2">
          <button type="button" onclick="closeLogMealModal()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded-lg font-semibold transition">Huỷ</button>
          <button type="submit" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg font-semibold transition">Lưu</button>
        </div>
      </form>
    </div>
  </div>
  <script>
    function openLogMealModal() {
      document.getElementById('logMealModal').classList.remove('hidden');
    }
    function closeLogMealModal() {
      document.getElementById('logMealModal').classList.add('hidden');
    }
  </script>
  <!-- Modal Thêm Món Ăn -->
  <div id="addMealModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 hidden transition-opacity duration-300 ease-in-out">
    <div class="bg-white p-6 rounded-2xl shadow-lg w-full max-w-md space-y-4">
      <h2 class="text-2xl font-bold text-blue-600 flex items-center gap-2">
        <span>➕</span> Thêm món ăn
      </h2>
      <form action="/add-meal" method="POST" class="space-y-3">
        <div>
          <label for="addName" class="block mb-1 font-medium text-gray-700">Tên món</label>
          <input name="name" id="addName" placeholder="Tên món ăn" class="w-full border border-gray-300 p-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400 transition" required>
        </div>
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label for="addCalories" class="block mb-1 font-medium text-gray-700">Calories</label>
            <input name="calories" id="addCalories" type="number" placeholder="Calories" class="w-full border border-gray-300 p-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400 transition" required>
          </div>
          <div>
            <label for="addProtein" class="block mb-1 font-medium text-gray-700">Protein (g)</label>
            <input name="protein" id="addProtein" type="number" placeholder="Protein (g)" class="w-full border border-gray-300 p-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400 transition" required>
          </div>
          <div>
            <label for="addCarbs" class="block mb-1 font-medium text-gray-700">Carbs (g)</label>
            <input name="carbs" id="addCarbs" type="number" placeholder="Carbs (g)" class="w-full border border-gray-300 p-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400 transition" required>
          </div>
          <div>
            <label for="addFat" class="block mb-1 font-medium text-gray-700">Fat (g)</label>
            <input name="fat" id="addFat" type="number" placeholder="Fat (g)" class="w-full border border-gray-300 p-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400 transition" required>
          </div>
        </div>
        <div class="flex justify-end gap-3 pt-2">
          <button type="button" onclick="closeAddMealModal()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded-lg font-semibold transition">Huỷ</button>
          <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold transition">Thêm</button>
        </div>
        <div>
  <label for="addImageUrl" class="block mb-1 font-medium text-gray-700">Link ảnh (tuỳ chọn)</label>
  <input name="image_url" id="addImageUrl" type="url" placeholder="https://..." class="w-full border border-gray-300 p-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400 transition">
</div>
      </form>
    </div>
  </div>
  <script>
    function openAddMealModal() {
      document.getElementById('addMealModal').classList.remove('hidden');
    }
    function closeAddMealModal() {
      document.getElementById('addMealModal').classList.add('hidden');
    }
  </script>
  <!-- Modal sửa món ăn -->
  <div id="editMealModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 hidden transition-opacity duration-300 ease-in-out">
    <div class="bg-white p-6 rounded-2xl shadow-lg w-full max-w-md space-y-4">
      <h2 class="text-2xl font-bold text-blue-600 flex items-center gap-2">
        <span>✏️</span> Sửa món ăn
      </h2>
      <form id="editMealForm" method="POST" class="space-y-3">
        <input type="hidden" name="meal_id" id="editMealId" />
        <div>
          <label for="editName" class="block mb-1 font-medium text-gray-700">Tên món</label>
          <input type="text" id="editName" name="name" class="w-full border border-gray-300 p-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400 transition" required />
        </div>
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label for="editCalories" class="block mb-1 font-medium text-gray-700">Calories</label>
            <input type="number" id="editCalories" name="calories" class="w-full border border-gray-300 p-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400 transition" required />
          </div>
          <div>
            <label for="editProtein" class="block mb-1 font-medium text-gray-700">Protein (g)</label>
            <input type="number" id="editProtein" name="protein" class="w-full border border-gray-300 p-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400 transition" required />
          </div>
          <div>
            <label for="editCarbs" class="block mb-1 font-medium text-gray-700">Carbs (g)</label>
            <input type="number" id="editCarbs" name="carbs" class="w-full border border-gray-300 p-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400 transition" required />
          </div>
          <div>
            <label for="editFat" class="block mb-1 font-medium text-gray-700">Fat (g)</label>
            <input type="number" id="editFat" name="fat" class="w-full border border-gray-300 p-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400 transition" required />
          </div>
        </div>
        <div class="flex justify-end gap-3 pt-2">
          <button type="button" onclick="closeEditMealModal()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded-lg font-semibold transition">Huỷ</button>
          <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold transition">Lưu</button>
        </div>
        <div>
  <label for="editImageUrl" class="block mb-1 font-medium text-gray-700">Link ảnh (tuỳ chọn)</label>
  <input type="url" id="editImageUrl" name="image_url" class="w-full border border-gray-300 p-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400 transition" />
</div>
      </form>
    </div>
  </div>
  <script>
    function openEditMealModal(meal) {
      document.getElementById('editMealId').value = meal._id;
      document.getElementById('editName').value = meal.name;
      document.getElementById('editCalories').value = meal.calories;
      document.getElementById('editProtein').value = meal.protein;
      document.getElementById('editCarbs').value = meal.carbs;
      document.getElementById('editFat').value = meal.fat;
      document.getElementById('editImageUrl').value = meal.image_url || ""; 
      document.getElementById('editMealForm').action = '/edit-meal/' + meal._id;
      document.getElementById('editMealModal').classList.remove('hidden');
    }
    document.querySelectorAll('.editMealBtn').forEach(btn => {
      btn.addEventListener('click', () => {
        const meal = JSON.parse(btn.dataset.meal);
        openEditMealModal(meal);
      });
    });
    function closeEditMealModal() {
      document.getElementById('editMealModal').classList.add('hidden');
    }
  </script>
  <!-- Modal xác nhận xoá -->
  <div id="deleteModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg shadow-lg p-6 w-full max-w-sm">
      <h2 class="text-xl font-semibold mb-4">🗑️ Xác nhận xoá</h2>
      <p class="text-gray-700 mb-4">Bạn có chắc chắn muốn xoá món ăn này?</p>
      <div class="flex justify-end gap-3">
        <button onclick="closeModal()" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded">Huỷ</button>
        <form id="confirmDeleteForm" method="POST">
          <button type="submit" class="px-4 py-2 bg-red-500 text-white hover:bg-red-600 rounded">Xoá</button>
        </form>
      </div>
    </div>
  </div>
  <script>
    function openModal(mealId) {
      const modal = document.getElementById("deleteModal");
      const form = document.getElementById("confirmDeleteForm");
      form.action = "/delete-meal/" + mealId;
      modal.classList.remove("hidden");
    }
    function closeModal() {
      document.getElementById("deleteModal").classList.add("hidden");
    }
  </script>
<style>
.sidebar.collapsed > *:not(#sidebarToggleBtn):not(.w-full) {
  display: none !important;
}
.sidebar.collapsed .w-full > *:not(img) {
  display: none !important;
}
.sidebar.collapsed .w-full img {
  width: 2.5rem !important;
  height: 2.5rem !important;
}
.sidebar.collapsed {
  width: 4rem !important;
  padding-left: 0.5rem !important;
  padding-right: 0.5rem !important;
  overflow: hidden !important;
}
.sidebar.collapsed nav {
  display: none !important;
}
.sidebar.collapsed button[onclick*="toggleSidebar"] {
  left: 40px !important;
  right: auto !important;
}
  /* Khi sidebar bị collapse */
  #sidebar.collapsed {
    width: 4rem; /* w-16 */
  }
  #sidebar.collapsed .sidebar-text {
    display: none;
  }
  .sidebar-btn {
  @apply flex items-center gap-3 px-4 py-3 rounded-xl font-semibold text-white bg-gradient-to-r from-blue-400 to-green-400 shadow hover:from-green-400 hover:to-blue-400 hover:scale-105 transition-all duration-200;
  margin-bottom: 0.25rem;
  border: none;
  outline: none;
  cursor: pointer;
}
.sidebar-btn:active {
  @apply scale-95;
}
.sidebar-btn .sidebar-text {
  @apply transition-all duration-200;
}
.sidebar.collapsed .sidebar-text {
  display: none !important;
}
.sidebar.collapsed .sidebar-btn {
  justify-content: center;
  padding-left: 0.5rem;
  padding-right: 0.5rem;
}
.sidebar.collapsed .w-full > *:not(img) {
  display: none !important;
}
.sidebar.collapsed .w-full img {
  width: 2.5rem !important;
  height: 2.5rem !important;
}
.sidebar.collapsed {
  width: 4rem !important;
  padding-left: 0.5rem !important;
  padding-right: 0.5rem !important;
  overflow: hidden !important;
}
.sidebar.collapsed nav {
  display: block !important;
}

#sidebar.collapsed {
  width: 4rem;
}
#sidebar.collapsed .sidebar-text {
  display: none;
}
  .sidebar-btn {
    @apply flex items-center gap-3 px-4 py-3 rounded-xl text-white font-medium transition-all duration-200 ease-in-out hover:bg-blue-500/50 focus:outline-none;
  }
  .sidebar-btn.active {
    @apply bg-white text-blue-700 shadow-md font-semibold;
  }
  .sidebar-text {
    @apply whitespace-nowrap;
  }
</style>
<script>
  function switchView(view) {
  document.getElementById("mealsView").classList.add("hidden");
  document.getElementById("logView").classList.add("hidden");
  document.getElementById(view + "View").classList.remove("hidden");

  // Đánh dấu nút active
  document.querySelectorAll("aside button").forEach(btn => {
    btn.classList.remove("bg-white", "text-blue-700", "font-semibold", "shadow-md");
  });
  const activeBtn = document.getElementById("btn-" + view);
  if (activeBtn) {
    activeBtn.classList.add("bg-white", "text-blue-700", "font-semibold", "shadow-md");
  }
}

</script>
  </body>
  </html>
