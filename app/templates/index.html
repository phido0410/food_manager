<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Nháº­t KÃ½ Ä‚n Uá»‘ng</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" /> <!-- ThÃªm dÃ²ng nÃ y -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-100 font-sans">
  <!-- Header má»›i -->
<header class="flex flex-col sm:flex-row items-center sm:justify-between px-2 sm:px-8 py-2 sm:py-4 bg-gradient-to-r from-blue-500 via-green-400 to-yellow-300 shadow-lg sticky top-0 z-40">
  <div class="flex w-full items-center justify-between">
    <div class="flex items-center gap-2">
      <img src="/static/logo.png" class="w-10 h-10 sm:w-12 sm:h-12 rounded-full border-4 border-white shadow" alt="Logo" />
      <button onclick="goHome()" class="text-xl sm:text-3xl font-extrabold text-white tracking-wide flex items-center gap-2 focus:outline-none">
        SmartCalories
      </button>
    </div>
    <button id="sidebarToggleBtn" class="md:hidden text-white text-2xl ml-2" onclick="toggleSidebar()">â˜°</button>
  </div>
  <div class="flex items-center gap-2 sm:gap-4 mt-2 sm:mt-0 w-full sm:w-auto justify-center sm:justify-end">
    <img src="{{ user.avatar_url or '/static/default-avatar.png' }}" alt="Avatar" class="w-8 h-8 sm:w-10 sm:h-10 rounded-full border-2 border-white shadow" />
    <span class="text-white font-semibold text-base sm:text-lg truncate max-w-[80px] sm:max-w-none">
      {{ fullname }}
    </span>
    <a href="/logout" class="bg-white/20 hover:bg-white/40 text-white px-3 sm:px-4 py-1 sm:py-2 rounded-xl font-bold shadow transition flex items-center gap-2 text-base sm:text-lg">
      <span>ğŸšª</span> <span class="hidden xs:inline">ÄÄƒng xuáº¥t</span>
    </a>
  </div>
</header>
  <!-- Dashboard layout -->
  <main class="flex flex-col md:flex-row h-auto md:h-[calc(100vh-80px)] transition-all duration-300 ease-in-out">
    <!-- Sidebar -->
<aside id="sidebar" class="w-full md:w-64 bg-gradient-to-b from-blue-700 via-blue-500 to-blue-400 text-white p-4 space-y-2 shadow-lg fixed md:static top-0 left-0 h-full md:h-auto z-50 md:z-auto transform -translate-x-full md:translate-x-0 transition-transform duration-300 ease-in-out"
      style="max-width:100vw;">
      <button id="sidebarToggleBtn" class="md:hidden mb-4 text-white text-2xl" onclick="toggleSidebar()">â˜°</button>
      <nav class="flex flex-col gap-1">
    <button onclick="switchView('meals')" id="btn-meals"
      class="flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-blue-600 transition-all duration-200 font-medium focus:outline-none">
      ğŸ“‹ <span>Danh sÃ¡ch mÃ³n</span>
    </button>
    <button onclick="switchView('log')" id="btn-log"
      class="flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-blue-600 transition-all duration-200 font-medium focus:outline-none">
      ğŸ“– <span>Nháº­t kÃ½ & PhÃ¢n tÃ­ch</span>
    </button>
    {% if user.role != 'admin' %}
<button onclick="openSuggestModal()"
  class="flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-blue-600 transition-all duration-200 font-medium focus:outline-none">
  ğŸ¥— <span>Gá»£i Ã½ mÃ³n Äƒn</span>
</button>
<button onclick="openLogMealModal()"
  class="flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-blue-600 transition-all duration-200 font-medium focus:outline-none">
  ğŸ“ <span>Ghi nháº­t kÃ½</span>
</button>
<button onclick="openActivityModal()"
  class="flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-blue-600 transition-all duration-200 font-medium focus:outline-none">
  ğŸƒ <span>Hoáº¡t Ä‘á»™ng thá»ƒ cháº¥t</span>
</button>
{% endif %}
    <button onclick="openProfileModal()"
  class="flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-blue-600 transition-all duration-200 font-medium focus:outline-none">
  ğŸ‘¤ <span>ThÃ´ng tin cÃ¡ nhÃ¢n</span>
</button>
{% if user.role == 'admin' %}
    <button onclick="openUserModal()"
      class="flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-blue-600 transition-all duration-200 font-medium focus:outline-none">
      ğŸ‘¥ <span>Quáº£n lÃ½ ngÆ°á»i dÃ¹ng</span>
    </button>
    {% endif %}
      {% if user.role == 'admin' %}
  <button onclick="openActivityLogModal()"
    class="flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-blue-600 transition-all duration-200 font-medium focus:outline-none">
    ğŸ“œ <span>Nháº­t kÃ½ hoáº¡t Ä‘á»™ng</span>
  </button>
  <button onclick="openLoginLogModal()"
    class="flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-blue-600 transition-all duration-200 font-medium focus:outline-none">
    ğŸ”‘ <span>Xem Ä‘Äƒng nháº­p</span>
  </button>
{% endif %}
    <div class="relative group">
  <button class="flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-blue-600 transition-all duration-200 font-medium focus:outline-none w-full">
    ğŸ“¤ <span>Xuáº¥t CSV</span>
  </button>
  <div class="absolute left-0 mt-1 hidden group-hover:block bg-white text-gray-800 shadow-lg rounded-lg overflow-hidden z-10 w-48">
    <a href="/export-csv?mode=today" class="block px-4 py-2 hover:bg-blue-100">ğŸ“† Xuáº¥t hÃ´m nay</a>
    <a href="/export-csv?mode=all" class="block px-4 py-2 hover:bg-blue-100">ğŸ“¦ Xuáº¥t táº¥t cáº£</a>
  </div>
</div>
  </nav>
</aside>
 <!-- Overlay for sidebar on mobile -->
<div id="sidebarOverlay" class="fixed inset-0 bg-black/40 z-40 hidden md:hidden" onclick="toggleSidebar()"></div>
    <!-- Content Area -->
    <section class="flex-1 overflow-y-auto p-2 sm:p-6 mt-16 md:mt-0">
      <!-- Meals View -->
      <div id="mealsView" class="hidden">
  <h2 class="text-2xl font-bold mb-4">ğŸ“‹ Danh sÃ¡ch mÃ³n Äƒn</h2>
  <form method="get" action="/" class="mb-4 flex gap-2">
    <input type="text" name="search" placeholder="TÃ¬m mÃ³n Äƒn..." value="{{ search | default('') }}"
      class="border border-gray-300 rounded-lg px-3 py-2 w-64 focus:outline-none focus:ring-2 focus:ring-blue-400 transition" />
    <input type="hidden" name="view" value="meals" />
    <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded-lg font-semibold hover:bg-blue-600 transition">TÃ¬m kiáº¿m</button>
  </form>
      <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4 sm:gap-6">
  {% for meal in meals %}
  <div class="bg-white p-4 rounded-xl shadow">
    {% if meal.image_url %}
      <img src="{{ meal.image_url }}" alt="{{ meal.name }}" class="w-full h-40 object-cover rounded-lg mb-3" />
    {% else %}
      <div class="w-full h-40 bg-gray-200 rounded-lg flex items-center justify-center mb-3 text-gray-500">KhÃ´ng cÃ³ áº£nh</div>
    {% endif %}
    <h3 class="text-lg font-semibold">{{ meal.name }}</h3>
    <ul class="text-sm mt-2 text-gray-600">
      <li>ğŸ”¥ Calories: {{ meal.calories }}</li>
      <li>ğŸ’ª Protein: {{ meal.protein }}g</li>
      <li>ğŸ Carbs: {{ meal.carbs }}g</li>
      <li>ğŸ¥‘ Fat: {{ meal.fat }}g</li>
    </ul>
    <div class="mt-4 flex gap-3">
  {% if user.role == 'admin' %}
    <button class="editMealBtn text-blue-600"
        data-id="{{ meal._id }}"
        data-name="{{ meal.name }}"
        data-calories="{{ meal.calories }}"
        data-date="{{ meal.date }}">
    âœï¸ Sá»­a
</button>
    <button onclick="openModal('{{ meal._id }}')" class="text-red-600">ğŸ—‘ï¸ XoÃ¡</button>
  {% endif %}
</div>
  </div>
  {% endfor %}
</div>
        </div>

        <!-- Logs and Analytics View -->
        <div id="logView" class="hidden">
  <h2 class="text-3xl font-extrabold text-blue-700 mb-4 flex items-center gap-2">ğŸ—“ï¸ Nháº­t kÃ½ hÃ´m nay</h2>
  <div class="bg-white rounded-xl shadow overflow-x-auto">
    <table class="min-w-full text-sm text-gray-700">
              <thead class="bg-gradient-to-r from-blue-600 to-blue-400 text-white text-base font-semibold">
  <tr>
    <th class="p-3 text-center border border-blue-800">MÃ³n</th>
    <th class="p-3 text-center border border-blue-800">Sá»‘ lÆ°á»£ng</th>
    <th class="p-3 text-center border border-blue-800">Calories</th>
    <th class="p-3 text-center border border-blue-800">Protein</th>
    <th class="p-3 text-center border border-blue-800">Carbs</th>
    <th class="p-3 text-center border border-blue-800">Fat</th>
  </tr>
</thead>
<tbody>
  {% for log in logs %}
  <tr class="odd:bg-white even:bg-blue-50 hover:bg-blue-100 transition-all">
    <td class="p-3 text-center border border-blue-100 whitespace-nowrap font-medium">{{ log.meal.name }}</td>
    <td class="p-3 text-center border border-blue-100">{{ log.quantity }}</td>
    <td class="p-3 text-center border border-blue-100">{{ log.meal.calories * log.quantity }}</td>
    <td class="p-3 text-center border border-blue-100">{{ log.meal.protein * log.quantity }}</td>
    <td class="p-3 text-center border border-blue-100">{{ log.meal.carbs * log.quantity }}</td>
    <td class="p-3 text-center border border-blue-100">{{ log.meal.fat * log.quantity }}</td>
  </tr>
  {% endfor %}
</tbody>
            </table>
          </div>

          <h2 class="text-3xl font-extrabold text-green-700 mt-10 mb-4 flex items-center gap-2">ğŸ“Š PhÃ¢n tÃ­ch hÃ´m nay</h2>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
  <div class="bg-white p-6 rounded-2xl shadow-xl hover:shadow-2xl transition">
    <h3 class="text-lg font-semibold mb-4 text-gray-700">ğŸ“ˆ Dinh dÆ°á»¡ng tá»•ng</h3>
    <canvas id="nutritionChart" class="h-64 w-full"></canvas>
  </div>
  <div class="bg-white p-6 rounded-2xl shadow-xl hover:shadow-2xl transition">
    <h3 class="text-lg font-semibold mb-4 text-gray-700">ğŸ¥— PhÃ¢n bá»‘ cháº¥t</h3>
    <canvas id="macroPieChart" class="max-w-full h-64"></canvas>
  </div>
</div>
        </div>
        <div id="welcomeView" class="flex flex-col items-center justify-center h-full text-center text-gray-700 space-y-4">
  <img src="/static/trangchu.png" alt="Welcome" class="w-40 h-40">
  <h1 class="text-3xl font-bold">ChÃ o má»«ng Ä‘áº¿n vá»›i SmartCalories! ğŸ¥—</h1>
  <p class="text-lg">HÃ£y chá»n má»™t má»¥c tá»« menu bÃªn trÃ¡i Ä‘á»ƒ báº¯t Ä‘áº§u quáº£n lÃ½ kháº©u pháº§n Äƒn cá»§a báº¡n.</p>
</div>
      </section>
    </main>

    <!-- JS Script -->
    <script>
      const summary = {
        calories: {{ summary.total_calories | default(0) }},
        protein: {{ summary.total_protein | default(0) }},
        carbs: {{ summary.total_carbs | default(0) }},
        fat: {{ summary.total_fat | default(0) }},
      };

      function switchView(view) {
        document.getElementById("mealsView").classList.add("hidden");
        document.getElementById("logView").classList.add("hidden");
        document.getElementById(view + "View").classList.remove("hidden");
      }

      window.onload = () => {
    // áº¨n táº¥t cáº£ view ban Ä‘áº§u
    document.getElementById("mealsView").classList.add("hidden");
    document.getElementById("logView").classList.add("hidden");
  };

      new Chart(document.getElementById("nutritionChart"), {
  type: 'bar',
  data: {
    labels: ['Calories', 'Protein', 'Carbs', 'Fat'],
    datasets: [{
      label: 'Dinh dÆ°á»¡ng hÃ´m nay',
      data: [summary.calories, summary.protein, summary.carbs, summary.fat],
      backgroundColor: [
        'rgba(255,99,132,0.8)',  // Ä‘á»
        'rgba(54,162,235,0.8)',  // xanh dÆ°Æ¡ng
        'rgba(255,206,86,0.8)',  // vÃ ng
        'rgba(75,192,192,0.8)'   // xanh lÃ¡
      ],
      hoverBackgroundColor: [
        'rgba(255,99,132,1)',
        'rgba(54,162,235,1)',
        'rgba(255,206,86,1)',
        'rgba(75,192,192,1)'
      ],
      borderRadius: 12,
      borderWidth: 1
    }]
  },
  options: {
    responsive: true,
    plugins: {
      legend: { display: false },
      tooltip: {
        backgroundColor: '#1f2937',
        titleFont: { weight: 'bold', size: 14 },
        bodyFont: { size: 13 },
        padding: 10,
        callbacks: {
          label: function(ctx) {
            return `${ctx.label}: ${ctx.parsed.y} ${ctx.label === 'Calories' ? 'kcal' : 'g'}`;
          }
        }
      }
    },
    scales: {
      x: {
        grid: { display: false },
        ticks: { font: { size: 16, weight: 'bold' }, color: '#374151' }
      },
      y: {
        beginAtZero: true,
        grid: { color: '#e5e7eb' },
        ticks: { font: { size: 14 }, color: '#4b5563' }
      }
    }
  }
});


  // Macro Pie Chart
  new Chart(document.getElementById("macroPieChart"), {
  type: 'doughnut',
  data: {
    labels: ['Protein', 'Carbs', 'Fat'],
    datasets: [{
      data: [summary.protein, summary.carbs, summary.fat],
      backgroundColor: [
        'rgba(59,130,246,0.9)', // xanh dÆ°Æ¡ng
        'rgba(253,224,71,0.9)', // vÃ ng
        'rgba(52,211,153,0.9)'  // xanh lÃ¡
      ],
      hoverOffset: 14,
      borderColor: ['#2563eb', '#ca8a04', '#059669'],
      borderWidth: 2
    }]
  },
  options: {
    responsive: true,
    cutout: '65%',
    plugins: {
      legend: {
        display: true,
        position: 'bottom',
        labels: {
          font: { size: 15, weight: 'bold' },
          color: '#374151'
        }
      },
      tooltip: {
        callbacks: {
          label: function(ctx) {
            const total = ctx.dataset.data.reduce((a, b) => a + b, 0);
            const value = ctx.parsed;
            const percent = total ? ((value / total) * 100).toFixed(1) : 0;
            return `${ctx.label}: ${value}g (${percent}%)`;
          }
        }
      }
    }
  }
});
</script>
    <!-- Modal Ghi Nháº­t KÃ½ -->
  <div id="logMealModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 hidden transition-opacity duration-300 ease-in-out">
    <div class="bg-white p-6 rounded-2xl shadow-lg w-full max-w-md space-y-4">
      <h2 class="text-2xl font-bold text-green-600 flex items-center gap-2">
        <span>ğŸ“</span> Ghi nháº­t kÃ½
      </h2>
      <form action="/log-meal" method="POST" class="space-y-3">
        <select name="meal_id" class="w-full border border-gray-300 p-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-400 transition" required>
          {% for meal in meals %}
          <option value="{{ meal._id }}">{{ meal.name }}</option>
          {% endfor %}
        </select>
        <input name="quantity" type="number" placeholder="Sá»‘ lÆ°á»£ng" class="w-full border border-gray-300 p-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-400 transition" required>
        <input name="date" type="date" value="{{ today }}" class="w-full border border-gray-300 p-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-400 transition" required>
        <div class="flex justify-end gap-3 pt-2">
          <button type="button" onclick="closeLogMealModal()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded-lg font-semibold transition">Huá»·</button>
          <button type="submit" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg font-semibold transition">LÆ°u</button>
        </div>
      </form>
    </div>
  </div>
  <script>
    function openLogMealModal() {
      document.getElementById('logMealModal').classList.remove('hidden');
    }
    function closeLogMealModal() {
      document.getElementById('logMealModal').classList.add('hidden');
    }
  </script>
  <!-- Modal ThÃªm MÃ³n Ä‚n -->
  <div id="addMealModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 hidden transition-opacity duration-300 ease-in-out">
    <div class="bg-white p-6 rounded-2xl shadow-lg w-full max-w-md space-y-4">
      <h2 class="text-2xl font-bold text-blue-600 flex items-center gap-2">
        <span>â•</span> ThÃªm mÃ³n Äƒn
      </h2>
      <form action="/add-meal" method="POST" class="space-y-3">
        <div>
          <label for="addName" class="block mb-1 font-medium text-gray-700">TÃªn mÃ³n</label>
          <input name="name" id="addName" placeholder="TÃªn mÃ³n Äƒn" class="w-full border border-gray-300 p-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400 transition" required>
        </div>
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label for="addCalories" class="block mb-1 font-medium text-gray-700">Calories</label>
            <input name="calories" id="addCalories" type="number" placeholder="Calories" class="w-full border border-gray-300 p-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400 transition" required>
          </div>
          <div>
            <label for="addProtein" class="block mb-1 font-medium text-gray-700">Protein (g)</label>
            <input name="protein" id="addProtein" type="number" placeholder="Protein (g)" class="w-full border border-gray-300 p-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400 transition" required>
          </div>
          <div>
            <label for="addCarbs" class="block mb-1 font-medium text-gray-700">Carbs (g)</label>
            <input name="carbs" id="addCarbs" type="number" placeholder="Carbs (g)" class="w-full border border-gray-300 p-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400 transition" required>
          </div>
          <div>
            <label for="addFat" class="block mb-1 font-medium text-gray-700">Fat (g)</label>
            <input name="fat" id="addFat" type="number" placeholder="Fat (g)" class="w-full border border-gray-300 p-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400 transition" required>
          </div>
        </div>
        <div class="flex justify-end gap-3 pt-2">
          <button type="button" onclick="closeAddMealModal()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded-lg font-semibold transition">Huá»·</button>
          <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold transition">ThÃªm</button>
        </div>
        <div>
  <label for="addImageUrl" class="block mb-1 font-medium text-gray-700">Link áº£nh (tuá»³ chá»n)</label>
  <input name="image_url" id="addImageUrl" type="url" placeholder="https://..." class="w-full border border-gray-300 p-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400 transition">
</div>
      </form>
    </div>
  </div>
  <script>
    function openAddMealModal() {
      document.getElementById('addMealModal').classList.remove('hidden');
    }
    function closeAddMealModal() {
      document.getElementById('addMealModal').classList.add('hidden');
    }
  </script>
  <!-- Modal sá»­a mÃ³n Äƒn -->
  <div id="editMealModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 hidden transition-opacity duration-300 ease-in-out">
    <div class="bg-white p-6 rounded-2xl shadow-lg w-full max-w-md space-y-4">
      <h2 class="text-2xl font-bold text-blue-600 flex items-center gap-2">
        <span>âœï¸</span> Sá»­a mÃ³n Äƒn
      </h2>
      <form id="editMealForm" method="POST" class="space-y-3">
        <input type="hidden" name="meal_id" id="editMealId" />
        <div>
          <label for="editName" class="block mb-1 font-medium text-gray-700">TÃªn mÃ³n</label>
          <input type="text" id="editName" name="name" class="w-full border border-gray-300 p-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400 transition" required />
        </div>
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label for="editCalories" class="block mb-1 font-medium text-gray-700">Calories</label>
            <input type="number" id="editCalories" name="calories" class="w-full border border-gray-300 p-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400 transition" required />
          </div>
          <div>
            <label for="editProtein" class="block mb-1 font-medium text-gray-700">Protein (g)</label>
            <input type="number" id="editProtein" name="protein" class="w-full border border-gray-300 p-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400 transition" required />
          </div>
          <div>
            <label for="editCarbs" class="block mb-1 font-medium text-gray-700">Carbs (g)</label>
            <input type="number" id="editCarbs" name="carbs" class="w-full border border-gray-300 p-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400 transition" required />
          </div>
          <div>
            <label for="editFat" class="block mb-1 font-medium text-gray-700">Fat (g)</label>
            <input type="number" id="editFat" name="fat" class="w-full border border-gray-300 p-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400 transition" required />
          </div>
        </div>
        <div class="flex justify-end gap-3 pt-2">
          <button type="button" onclick="closeEditMealModal()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded-lg font-semibold transition">Huá»·</button>
          <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold transition">LÆ°u</button>
        </div>
        <div>
  <label for="editImageUrl" class="block mb-1 font-medium text-gray-700">Link áº£nh (tuá»³ chá»n)</label>
  <input type="url" id="editImageUrl" name="image_url" class="w-full border border-gray-300 p-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400 transition" />
</div>
      </form>
    </div>
  </div>
  <script>
    function openEditMealModal(meal) {
      document.getElementById('editMealId').value = meal._id;
      document.getElementById('editName').value = meal.name;
      document.getElementById('editCalories').value = meal.calories;
      document.getElementById('editProtein').value = meal.protein;
      document.getElementById('editCarbs').value = meal.carbs;
      document.getElementById('editFat').value = meal.fat;
      document.getElementById('editImageUrl').value = meal.image_url || ""; 
      document.getElementById('editMealForm').action = '/edit-meal/' + meal._id;
      document.getElementById('editMealModal').classList.remove('hidden');
    }
    document.querySelectorAll('.editMealBtn').forEach(btn => {
      btn.addEventListener('click', () => {
        const meal = JSON.parse(btn.dataset.meal);
        openEditMealModal(meal);
      });
    });
    function closeEditMealModal() {
      document.getElementById('editMealModal').classList.add('hidden');
    }
  </script>
  <!-- Modal xÃ¡c nháº­n xoÃ¡ -->
  <div id="deleteModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg shadow-lg p-6 w-full max-w-sm">
      <h2 class="text-xl font-semibold mb-4">ğŸ—‘ï¸ XÃ¡c nháº­n xoÃ¡</h2>
      <p class="text-gray-700 mb-4">Báº¡n cÃ³ cháº¯c cháº¯n muá»‘n xoÃ¡ mÃ³n Äƒn nÃ y?</p>
      <div class="flex justify-end gap-3">
        <button onclick="closeModal()" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded">Huá»·</button>
        <form id="confirmDeleteForm" method="POST">
          <button type="submit" class="px-4 py-2 bg-red-500 text-white hover:bg-red-600 rounded">XoÃ¡</button>
        </form>
      </div>
    </div>
  </div>
  <script>
    function openModal(mealId) {
      const modal = document.getElementById("deleteModal");
      const form = document.getElementById("confirmDeleteForm");
      form.action = "/delete-meal/" + mealId;
      modal.classList.remove("hidden");
    }
    function closeModal() {
      document.getElementById("deleteModal").classList.add("hidden");
    }
  </script>
  <!-- Modal Gá»£i Ã½ mÃ³n Äƒn -->
<div id="suggestModal" class="fixed inset-0 bg-black/40 flex items-center justify-center z-50 hidden">
  <div class="bg-white rounded-xl shadow-lg w-full max-w-3xl max-h-[90vh] overflow-hidden p-6 flex flex-col">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-xl font-bold text-yellow-700 flex items-center gap-2">
        ğŸ¥— Gá»£i Ã½ mÃ³n Äƒn & Äáº·t má»¥c tiÃªu
      </h2>
      <button onclick="closeSuggestModal()" class="text-gray-500 hover:text-red-500 text-2xl font-bold">&times;</button>
    </div>
    <!-- Form Ä‘áº·t má»¥c tiÃªu -->
    <form method="post" action="/set-goals"
      class="flex gap-2 items-end mb-4 bg-blue-50 p-3 rounded-lg shadow"
      id="goalsForm"
      onsubmit="return submitGoalsForm(event)">
      <div>
  <label class="block text-xs font-bold mb-1">Calories</label>
  <input type="number" name="calories" value="0" min="0" class="border rounded px-2 py-1 w-20" required />
</div>
<div>
  <label class="block text-xs font-bold mb-1">Protein</label>
  <input type="number" name="protein" value="0" min="0" class="border rounded px-2 py-1 w-20" required />
</div>
<div>
  <label class="block text-xs font-bold mb-1">Carbs</label>
  <input type="number" name="carbs" value="0" min="0" class="border rounded px-2 py-1 w-20" required />
</div>
<div>
  <label class="block text-xs font-bold mb-1">Fat</label>
  <input type="number" name="fat" value="0" min="0" class="border rounded px-2 py-1 w-20" required />
</div>
      <button type="submit" class="bg-blue-500 text-white px-3 py-1 rounded font-bold">LÆ°u má»¥c tiÃªu</button>
</form>
    <!-- ThÃ´ng bÃ¡o lÆ°á»£ng cÃ²n thiáº¿u -->
    <div class="mb-3 text-sm text-gray-700">
  Äang thiáº¿u:
  <span class="font-semibold text-red-600" id="missingCalories">Calories: {{ missing.calories }}</span>,
  <span class="font-semibold text-blue-600" id="missingProtein">Protein: {{ missing.protein }}</span>,
  <span class="font-semibold text-yellow-600" id="missingCarbs">Carbs: {{ missing.carbs }}</span>,
  <span class="font-semibold text-green-600" id="missingFat">Fat: {{ missing.fat }}</span>
</div>
<!-- Gá»£i Ã½ mÃ³n Äƒn -->
<div class="overflow-y-auto space-y-4 pr-2" id="suggestedMealGroups" style="max-height: 60vh;"></div>
  <div class="text-xs text-gray-500 mt-2">* Gá»£i Ã½ dá»±a trÃªn cháº¥t cÃ²n thiáº¿u nhiá»u nháº¥t hÃ´m nay</div>
</div>
  </div>
</div>
<script>
  function openSuggestModal() {
  document.getElementById('suggestModal').classList.remove('hidden');
  document.querySelector('input[name="calories"]').value = 0;
  document.querySelector('input[name="protein"]').value = 0;
  document.querySelector('input[name="carbs"]').value = 0;
  document.querySelector('input[name="fat"]').value = 0;
  // Reset cÃ¡c giÃ¡ trá»‹ "Äang thiáº¿u" vá» 0
  document.getElementById('missingCalories').textContent = "Calories: 0";
  document.getElementById('missingProtein').textContent = "Protein: 0";
  document.getElementById('missingCarbs').textContent = "Carbs: 0";
  document.getElementById('missingFat').textContent = "Fat: 0";
  // XoÃ¡ gá»£i Ã½ mÃ³n Äƒn cÅ©
  document.getElementById('suggestedMealGroups').innerHTML = "";
}
  // Náº¿u muá»‘n submit form khÃ´ng reload trang, cÃ³ thá»ƒ dÃ¹ng AJAX á»Ÿ Ä‘Ã¢y
</script>
<script>
  function openSuggestModal() {
    document.getElementById('suggestModal').classList.remove('hidden');
  }
  function closeSuggestModal() {
    document.getElementById('suggestModal').classList.add('hidden');
  }
</script>
<!-- Modal ThÃ´ng tin cÃ¡ nhÃ¢n -->
<div id="profileModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 hidden">
  <div class="bg-white p-8 rounded-xl shadow space-y-4 w-full max-w-md relative">
    <button onclick="closeProfileModal()" class="absolute top-2 right-3 text-2xl text-gray-400 hover:text-red-500 font-bold">&times;</button>
    <h2 class="text-2xl font-bold mb-4">ThÃ´ng tin cÃ¡ nhÃ¢n</h2>
    <!-- Cháº¿ Ä‘á»™ chá»‰ Ä‘á»c -->
    <div id="profileNotice" class="hidden mb-2 px-4 py-2 rounded text-white font-semibold"></div>
    
    <div id="profileViewMode">
      <div class="mb-4 flex justify-center">
      <img id="viewAvatar" src="{{ user.avatar_url or '' }}" alt="Avatar" class="w-24 h-24 rounded-full border-4 border-blue-300 shadow" />
      </div>
      <div class="mb-2"><b>Há» tÃªn:</b> <span id="viewFullname">{{ fullname }}</span></div>
      <div class="mb-2"><b>Email:</b> <span id="viewEmail">{{ user.email or "ChÆ°a cáº­p nháº­t" }}</span></div>
      <div class="mb-2"><b>Chiá»u cao:</b> <span id="viewHeight">{{ user.height or "ChÆ°a cáº­p nháº­t" }}</span> cm</div>
      <div class="mb-2"><b>CÃ¢n náº·ng:</b> <span id="viewWeight">{{ user.weight or "ChÆ°a cáº­p nháº­t" }}</span> kg</div>
      <div class="mb-2"><b>Tuá»•i:</b> <span id="viewAge">{{ user.age or "ChÆ°a cáº­p nháº­t" }}</span></div>
      <div class="mb-2"><b>Giá»›i tÃ­nh:</b> <span id="viewGender">
        {% if user.gender == "male" %}Nam{% elif user.gender == "female" %}Ná»¯{% else %}ChÆ°a cáº­p nháº­t{% endif %}
      </span></div>
      <div class="mb-2"><b>BMR:</b> <span id="viewBmr">{{ bmr if bmr else "ChÆ°a cÃ³" }}</span> kcal/ngÃ y</div>
      <div class="mb-2"><b>TDEE:</b> <span id="viewTdee">{{ tdee if tdee else "ChÆ°a cÃ³" }}</span> kcal/ngÃ y</div>
      <button onclick="switchToEditProfile()" class="mt-4 bg-blue-500 text-white px-4 py-2 rounded font-bold w-full">Chá»‰nh sá»­a</button>
    </div>
    <!-- Cháº¿ Ä‘á»™ chá»‰nh sá»­a -->
    <form id="profileForm" method="post" class="space-y-3 hidden" onsubmit="return submitProfileForm(event)" enctype="multipart/form-data">

  <div>
    <label class="block mb-1">Chiá»u cao (cm):</label>
    <input type="number" name="height" id="profileHeight" required class="border rounded px-3 py-2 w-full" />
  </div>
  <div>
    <label class="block mb-1">CÃ¢n náº·ng (kg):</label>
    <input type="number" name="weight" id="profileWeight" required class="border rounded px-3 py-2 w-full" />
  </div>
  <div>
    <label class="block mb-1">Tuá»•i:</label>
    <input type="number" name="age" id="profileAge" required class="border rounded px-3 py-2 w-full" />
  </div>
  <div>
    <label class="block mb-1">Giá»›i tÃ­nh:</label>
    <select name="gender" id="profileGender" required class="border rounded px-3 py-2 w-full">
      <option value="male">Nam</option>
      <option value="female">Ná»¯</option>
    </select>
  </div>
  <div>
    <label class="block mb-1">Email:</label>
    <input type="email" name="email" id="profileEmail" required class="border rounded px-3 py-2 w-full" />
  </div>
  <div>
    <label class="block mb-1">Chá»n áº£nh Ä‘áº¡i diá»‡n:</label>
    <input type="file" id="profileAvatarFile" accept="image/*" class="border rounded px-3 py-2 w-full" />
  </div>
  <div class="flex gap-2">
    <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded font-bold w-full">LÆ°u</button>
    <button type="button" onclick="switchToViewProfile()" class="bg-gray-300 text-gray-800 px-4 py-2 rounded font-bold w-full">Há»§y</button>
  </div>
</form>
  </div>
</div>
<style>
.sidebar.collapsed > *:not(#sidebarToggleBtn):not(.w-full) {
  display: none !important;
}
.sidebar.collapsed .w-full > *:not(img) {
  display: none !important;
}
.sidebar.collapsed .w-full img {
  width: 2.5rem !important;
  height: 2.5rem !important;
}
.sidebar.collapsed {
  width: 4rem !important;
  padding-left: 0.5rem !important;
  padding-right: 0.5rem !important;
  overflow: hidden !important;
}
.sidebar.collapsed nav {
  display: none !important;
}
.sidebar.collapsed button[onclick*="toggleSidebar"] {
  left: 40px !important;
  right: auto !important;
}
  /* Khi sidebar bá»‹ collapse */
  #sidebar.collapsed {
    width: 4rem; /* w-16 */
  }
  #sidebar.collapsed .sidebar-text {
    display: none;
  }
  .sidebar-btn {
  @apply flex items-center gap-3 px-4 py-3 rounded-xl font-semibold text-white bg-gradient-to-r from-blue-400 to-green-400 shadow hover:from-green-400 hover:to-blue-400 hover:scale-105 transition-all duration-200;
  margin-bottom: 0.25rem;
  border: none;
  outline: none;
  cursor: pointer;
}
.sidebar-btn:active {
  @apply scale-95;
}
.sidebar-btn .sidebar-text {
  @apply transition-all duration-200;
}
.sidebar.collapsed .sidebar-text {
  display: none !important;
}
.sidebar.collapsed .sidebar-btn {
  justify-content: center;
  padding-left: 0.5rem;
  padding-right: 0.5rem;
}
.sidebar.collapsed .w-full > *:not(img) {
  display: none !important;
}
.sidebar.collapsed .w-full img {
  width: 2.5rem !important;
  height: 2.5rem !important;
}
.sidebar.collapsed {
  width: 4rem !important;
  padding-left: 0.5rem !important;
  padding-right: 0.5rem !important;
  overflow: hidden !important;
}
.sidebar.collapsed nav {
  display: block !important;
}

#sidebar.collapsed {
  width: 4rem;
}
#sidebar.collapsed .sidebar-text {
  display: none;
}
  .sidebar-btn {
    @apply flex items-center gap-3 px-4 py-3 rounded-xl text-white font-medium transition-all duration-200 ease-in-out hover:bg-blue-500/50 focus:outline-none;
  }
  .sidebar-btn.active {
    @apply bg-white text-blue-700 shadow-md font-semibold;
  }
  .sidebar-text {
    @apply whitespace-nowrap;
  }
</style>
<script>
  function switchView(view) {
    // áº¨n táº¥t cáº£ view
    document.getElementById("welcomeView").classList.add("hidden");
    document.getElementById("mealsView").classList.add("hidden");
    document.getElementById("logView").classList.add("hidden");

    // Hiá»‡n view tÆ°Æ¡ng á»©ng
    document.getElementById(view + "View").classList.remove("hidden");

    // Cáº­p nháº­t tráº¡ng thÃ¡i active cho sidebar
    document.querySelectorAll("aside button").forEach(btn => {
      btn.classList.remove("bg-white", "text-blue-700", "font-semibold", "shadow-md");
    });
    const activeBtn = document.getElementById("btn-" + view);
    if (activeBtn) {
      activeBtn.classList.add("bg-white", "text-blue-700", "font-semibold", "shadow-md");
    }
  }

  function goHome() {
    // áº¨n táº¥t cáº£
    document.getElementById("mealsView").classList.add("hidden");
    document.getElementById("logView").classList.add("hidden");
    document.getElementById("welcomeView").classList.remove("hidden");

    // XoÃ¡ tráº¡ng thÃ¡i active
    document.querySelectorAll("aside button").forEach(btn => {
      btn.classList.remove("bg-white", "text-blue-700", "font-semibold", "shadow-md");
    });
  }

  window.onload = () => {
    const params = new URLSearchParams(window.location.search);
    const view = params.get("view");

    document.getElementById("mealsView").classList.add("hidden");
    document.getElementById("logView").classList.add("hidden");
    document.getElementById("welcomeView").classList.add("hidden");

    if (view === "log") {
      switchView("log");
    } else if (view === "meals") {
      switchView("meals");
    } else {
      document.getElementById("welcomeView").classList.remove("hidden");
    }
  };
</script>
<script>
function submitGoalsForm(event) {
  event.preventDefault();
  const form = document.getElementById('goalsForm');
  const formData = new FormData(form);

  fetch('/set-goals', {
    method: 'POST',
    body: formData,
    credentials: 'same-origin'
  })
  .then(res => res.json())
  .then(data => {
    // Cáº­p nháº­t lÆ°á»£ng cÃ²n thiáº¿u
    document.getElementById('missingCalories').textContent = "Calories: " + data.missing.calories;
    document.getElementById('missingProtein').textContent = "Protein: " + data.missing.protein;
    document.getElementById('missingCarbs').textContent = "Carbs: " + data.missing.carbs;
    document.getElementById('missingFat').textContent = "Fat: " + data.missing.fat;

    const container = document.getElementById('suggestedMealGroups');
    container.innerHTML = "";

    const nutrientLabels = {
      calories: "ğŸš Calories",
      protein: "ğŸ’ª Protein",
      carbs: "ğŸ Carbs",
      fat: "ğŸ¥‘ Fat"
    };

    Object.keys(data.suggested_meals).forEach(nutrient => {
      const group = document.createElement('div');

      const toggleBtn = document.createElement('button');
      toggleBtn.textContent = `áº¨n/Hiá»‡n gá»£i Ã½ ${nutrientLabels[nutrient]}`;
      toggleBtn.className = "mb-2 text-sm font-semibold bg-yellow-200 px-3 py-1 rounded shadow hover:bg-yellow-300";
      
      const list = document.createElement('div');
      list.className = "grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4";
      list.id = `group-${nutrient}`;

      toggleBtn.onclick = () => {
        list.classList.toggle("hidden");
      };

      const title = document.createElement('div');
      title.className = "font-semibold text-yellow-700 mt-2 mb-1";
      title.textContent = `Gá»£i Ã½ theo ${nutrientLabels[nutrient]} cÃ²n thiáº¿u:`;

      const meals = data.suggested_meals[nutrient];
      if (meals.length === 0) {
        const msg = document.createElement("div");
        msg.className = "text-gray-500 italic col-span-3";
        msg.textContent = "KhÃ´ng cÃ³ mÃ³n phÃ¹ há»£p.";
        list.appendChild(msg);
      } else {
        meals.forEach(meal => {
          const card = document.createElement("div");
          card.className = "bg-yellow-50 p-3 rounded-lg shadow text-center";

          if (meal.image_url) {
            const img = document.createElement("img");
            img.src = meal.image_url + "?t=" + new Date().getTime();
            img.alt = meal.name;
            img.className = "w-full h-24 object-cover rounded mb-2";
            card.appendChild(img);
          }

          const name = document.createElement("div");
          name.className = "font-bold text-blue-700 mb-1";
          name.textContent = meal.name;
          card.appendChild(name);

          const info = document.createElement("div");
          info.className = "text-sm text-gray-600";
          info.innerHTML = `ğŸ”¥ ${meal.calories} cal<br>ğŸ’ª ${meal.protein}g â€¢ ğŸ ${meal.carbs}g â€¢ ğŸ¥‘ ${meal.fat}g`;
          card.appendChild(info);

          list.appendChild(card);
        });
      }

      group.appendChild(toggleBtn);
      group.appendChild(title);
      group.appendChild(list);
      container.appendChild(group);
    });
  });

  return false;
}
</script>
<script>
  // Láº¥y thÃ´ng tin user tá»« backend (Jinja2)
  const userProfile = {
  fullname: "{{ fullname }}",
  email: "{{ user.email or '' }}",
  height: {{ user.height if user and user.height is defined else 'null' }},
  weight: {{ user.weight if user and user.weight is defined else 'null' }},
  age: {{ user.age if user and user.age is defined else 'null' }},
  gender: "{{ user.gender if user and user.gender is defined else '' }}",
  bmr: {{ bmr if bmr is defined and bmr else 'null' }},
  tdee: {{ tdee if tdee is defined and tdee else 'null' }},
  avatar_url: "{{ user.avatar_url or '' }}"
  };

  function openProfileModal() {
  document.getElementById('profileModal').classList.remove('hidden');
  switchToViewProfile();
  document.getElementById('viewFullname').textContent = userProfile.fullname || '';
  document.getElementById('viewHeight').textContent = userProfile.height || 'ChÆ°a cáº­p nháº­t';
  document.getElementById('viewWeight').textContent = userProfile.weight || 'ChÆ°a cáº­p nháº­t';
  document.getElementById('viewAge').textContent = userProfile.age || 'ChÆ°a cáº­p nháº­t';
  document.getElementById('viewGender').textContent = userProfile.gender === 'male' ? 'Nam' : (userProfile.gender === 'female' ? 'Ná»¯' : 'ChÆ°a cáº­p nháº­t');
  document.getElementById('viewEmail').textContent = userProfile.email || 'ChÆ°a cáº­p nháº­t';
  document.getElementById('viewBmr').textContent = userProfile.bmr || 'ChÆ°a cÃ³';
  document.getElementById('viewTdee').textContent = userProfile.tdee || 'ChÆ°a cÃ³';
  document.getElementById('viewAvatar').src = userProfile.avatar_url || '';

}
  function closeProfileModal() {
    document.getElementById('profileModal').classList.add('hidden');
  }
  function switchToEditProfile() {
    document.getElementById('profileViewMode').classList.add('hidden');
    document.getElementById('profileForm').classList.remove('hidden');
    document.getElementById('profileHeight').value = userProfile.height || '';
    document.getElementById('profileWeight').value = userProfile.weight || '';
    document.getElementById('profileAge').value = userProfile.age || '';
    document.getElementById('profileGender').value = userProfile.gender || 'male';
    document.getElementById('profileEmail').value = userProfile.email || '';
    document.getElementById('profileAvatarFile').value = '';
  }
  document.getElementById('profileAvatarFile').addEventListener('change', function (e) {
  const file = e.target.files[0];
  if (file) {
    const reader = new FileReader();
    reader.onload = function (ev) {
      document.getElementById('viewAvatar').src = ev.target.result;
    };
    reader.readAsDataURL(file);
  }
});
  function switchToViewProfile() {
    document.getElementById('profileViewMode').classList.remove('hidden');
    document.getElementById('profileForm').classList.add('hidden');
  }
  // Gá»­i form cáº­p nháº­t thÃ´ng tin cÃ¡ nhÃ¢n báº±ng fetch (AJAX)
  function showProfileNotice(message, success = true) {
  const notice = document.getElementById('profileNotice');
  notice.textContent = message;
  notice.className = 'mb-2 px-4 py-2 rounded font-semibold ' + (success ? 'bg-green-500' : 'bg-red-500');
  notice.style.display = '';
  setTimeout(() => { notice.style.display = 'none'; }, 2500);
}

function submitProfileForm(event) {
    event.preventDefault();
    const form = document.getElementById('profileForm');
    const formData = new FormData(form);

    // Náº¿u cÃ³ file, thÃªm vÃ o formData
    const fileInput = document.getElementById('profileAvatarFile');
    if (fileInput.files.length > 0) {
      formData.append('avatar_file', fileInput.files[0]);
    }

    fetch('/profile', {
      method: 'POST',
      body: formData,
      credentials: 'same-origin'
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        userProfile.height = data.data.height;
        userProfile.weight = data.data.weight;
        userProfile.age = data.data.age;
        userProfile.gender = data.data.gender;
        userProfile.email = data.data.email;
        userProfile.bmr = data.data.bmr;
        userProfile.tdee = data.data.tdee;
        userProfile.avatar_url = data.data.avatar_url || '';
        switchToViewProfile();
        openProfileModal();
        showProfileNotice(data.message, true);
      } else {
        showProfileNotice(data.message || "CÃ³ lá»—i xáº£y ra!", false);
      }
    });
    return false;
  }
</script>
<!-- Modal Quáº£n lÃ½ ngÆ°á»i dÃ¹ng (chá»‰ admin) Ä‘áº·t trÆ°á»›c </body> -->
{% if user.role == 'admin' %}
<div id="userModal" class="fixed inset-0 bg-black/40 flex items-center justify-center z-50 hidden">
  <div class="bg-white rounded-2xl shadow-2xl w-full max-w-3xl max-h-[90vh] overflow-auto p-8 flex flex-col">
    <div class="flex justify-between items-center mb-6">
      <h2 class="text-2xl font-bold text-blue-700 flex items-center gap-2">
        ğŸ‘¥ Danh sÃ¡ch ngÆ°á»i dÃ¹ng
      </h2>
      <button onclick="closeUserModal()" class="text-gray-500 hover:text-red-500 text-3xl font-bold">&times;</button>
    </div>
    <div class="overflow-y-auto max-h-[70vh] scrollbar-thin scroll-smooth">
    <table class="min-w-full text-base">
        <thead class="bg-gradient-to-r from-blue-600 to-blue-400 text-white font-semibold">
          <tr>
            <th class="p-3 text-center">Avatar</th>
            <th class="p-3 text-left">TÃªn</th>
            <th class="p-3 text-left">Email</th>
            <th class="p-3 text-center">Quyá»n</th>
            <th class="p-3 text-center">Tráº¡ng thÃ¡i</th>
            <th class="p-3 text-center">HÃ nh Ä‘á»™ng</th>
          </tr>
        </thead>
        <tbody>
          {% for u in users %}
          <tr class="even:bg-blue-50 odd:bg-white hover:bg-blue-100 transition">
            <td class="p-3 text-center">
              <img src="{{ u.avatar_url or '/static/default-avatar.png' }}" alt="Avatar" class="w-10 h-10 rounded-full border-2 border-blue-300 mx-auto shadow" />
            </td>
            <td class="p-3 font-semibold text-blue-800">{{ u.fullname }}</td>
            <td class="p-3 text-gray-700">{{ u.email }}</td>
            <td class="p-3 text-center">
              {% if u.role == 'admin' %}
                <span class="bg-yellow-200 text-yellow-800 px-2 py-1 rounded font-bold text-xs">Admin</span>
              {% else %}
                <span class="bg-green-100 text-green-700 px-2 py-1 rounded font-bold text-xs">User</span>
              {% endif %}
            </td>
            <td class="p-3 text-center">
              {% if u.is_banned %}
                <span class="bg-red-100 text-red-600 px-2 py-1 rounded font-bold text-xs">Banned</span>
              {% else %}
                <span class="bg-green-100 text-green-700 px-2 py-1 rounded font-bold text-xs">Active</span>
              {% endif %}
            </td>
            <td class="p-3 text-center">
  <div class="flex justify-center gap-3">
    {% if u.is_banned %}
      <button onclick="toggleBan('{{ u._id }}', false)" class="bg-green-500 hover:bg-green-600 text-white w-10 h-10 rounded-full flex items-center justify-center shadow transition" title="Unban">
        <span class="text-xl">ğŸ”“</span>
      </button>
    {% else %}
      <button onclick="toggleBan('{{ u._id }}', true)" class="bg-red-500 hover:bg-red-600 text-white w-10 h-10 rounded-full flex items-center justify-center shadow transition" title="Ban">
        <span class="text-xl">ğŸ”’</span>
      </button>
    {% endif %}
    {% if u._id != user._id %}
      <button onclick="toggleRole('{{ u._id }}', '{{ u.role }}')" class="bg-yellow-400 hover:bg-yellow-500 text-white w-10 h-10 rounded-full flex items-center justify-center shadow transition" title="Äá»•i quyá»n">
        <span class="text-xl">ğŸ”„</span>
      </button>
      <button onclick="confirmDeleteUser('{{ u._id }}')" class="bg-red-400 hover:bg-red-600 text-white w-10 h-10 rounded-full flex items-center justify-center shadow transition" title="XÃ³a ngÆ°á»i dÃ¹ng">
        <span class="text-xl">ğŸ—‘ï¸</span>
      </button>
    {% endif %}
  </div>
</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>
{% endif %}
<script>
function openUserModal() {
  document.getElementById('userModal').classList.remove('hidden');
}
function closeUserModal() {
  document.getElementById('userModal').classList.add('hidden');
}
function toggleBan(userId, ban) {
  fetch('/ban-user', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({user_id: userId, ban: ban}),
    credentials: 'same-origin'
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) {
      location.reload();
    } else {
      showNotice(data.message || "CÃ³ lá»—i xáº£y ra!");
    }
  });
}
function toggleRole(userId, currentRole) {
  const newRole = currentRole === 'admin' ? 'user' : 'admin';
  if (!confirm(`Báº¡n cÃ³ cháº¯c muá»‘n Ä‘á»•i quyá»n thÃ nh "${newRole}"?`)) return;
  fetch('/change-role', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({user_id: userId, role: newRole}),
    credentials: 'same-origin'
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) {
      location.reload();
    } else {
      showNotice(data.message || "CÃ³ lá»—i xáº£y ra!");
    }
  });
}
</script>
<!-- Modal thÃ´ng bÃ¡o Ä‘Äƒng xuáº¥t -->
<div id="logoutNoticeModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-[9999] hidden">
  <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full text-center animate-fade-in">
    <div class="text-red-500 text-5xl mb-4">
      <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto w-14 h-14" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01M12 4a8 8 0 100 16 8 8 0 000-16z" />
      </svg>
    </div>
    <div id="logoutNoticeMsg" class="text-xl font-semibold text-gray-800 mb-6"></div>
    <a href="/login" class="inline-block bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-6 rounded-full shadow-lg transition duration-300 ease-in-out">
      ÄÄƒng nháº­p láº¡i
    </a>
  </div>
</div>

<style>
@keyframes fade-in {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}
.animate-fade-in {
  animation: fade-in 0.4s ease-out;
}
</style>

<script>
function showLogoutNotice(msg) {
  document.getElementById('logoutNoticeMsg').textContent = msg;
  document.getElementById('logoutNoticeModal').classList.remove('hidden');
  setTimeout(() => {
    window.location.href = '/login';
  }, 2500);
}

function checkSession() {
  fetch('/check-session', {credentials: 'include'})
    .then(res => res.json())
    .then(data => {
      if (!data.valid) {
        let msg = '';
        if (data.reason === 'ban') msg = 'TÃ i khoáº£n cá»§a báº¡n Ä‘Ã£ bá»‹ khÃ³a!';
        else if (data.reason === 'other_login') msg = 'TÃ i khoáº£n Ä‘Ã£ Ä‘Äƒng nháº­p á»Ÿ nÆ¡i khÃ¡c!';
        else msg = 'PhiÃªn Ä‘Äƒng nháº­p Ä‘Ã£ háº¿t háº¡n!';
        showLogoutNotice(msg);
      }
    });
}
setInterval(checkSession, 10000);

function toggleRole(userId, currentRole) {
  const newRole = currentRole === 'admin' ? 'user' : 'admin';
  // XoÃ¡ dÃ²ng confirm Ä‘á»ƒ khÃ´ng hiá»‡n popup xÃ¡c nháº­n
  fetch('/change-role', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({user_id: userId, role: newRole}),
    credentials: 'same-origin'
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) {
      showNotice("Äá»•i quyá»n thÃ nh cÃ´ng!", true);
      setTimeout(() => location.reload(), 1200);
    } else {
      showNotice(data.message || "CÃ³ lá»—i xáº£y ra!", false);
    }
  });
}
</script>
<div id="customNotice" class="fixed top-8 left-1/2 -translate-x-1/2 z-[9999] hidden px-6 py-3 rounded-xl shadow-2xl font-semibold text-white text-lg transition-all duration-300"></div>
<script>
function showNotice(msg, success=true) {
  const el = document.getElementById('customNotice');
  el.textContent = msg;
  el.className = "fixed top-8 left-1/2 -translate-x-1/2 z-[9999] px-6 py-3 rounded-xl shadow-2xl font-semibold text-lg transition-all duration-300 " + (success ? "bg-green-600" : "bg-red-600");
  el.style.display = '';
  setTimeout(() => { el.style.display = 'none'; }, 2200);
}
</script>
<!-- Modal xÃ¡c nháº­n xÃ³a ngÆ°á»i dÃ¹ng -->
<div id="deleteUserModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-[9999] hidden">
  <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full text-center animate-fade-in">
    <div class="text-red-500 text-5xl mb-4">
      <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto w-14 h-14" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01M12 4a8 8 0 100 16 8 8 0 000-16z" />
      </svg>
    </div>
    <div class="text-xl font-semibold text-gray-800 mb-6">Báº¡n cÃ³ cháº¯c cháº¯n muá»‘n xÃ³a ngÆ°á»i dÃ¹ng nÃ y?</div>
    <div class="flex justify-center gap-4">
      <button onclick="closeDeleteUserModal()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded font-bold">Há»§y</button>
      <button id="confirmDeleteUserBtn" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded font-bold">XÃ³a</button>
    </div>
  </div>
</div>

<script>
let userIdToDelete = null;
function confirmDeleteUser(userId) {
  userIdToDelete = userId;
  document.getElementById('deleteUserModal').classList.remove('hidden');
}
function closeDeleteUserModal() {
  userIdToDelete = null;
  document.getElementById('deleteUserModal').classList.add('hidden');
}
document.getElementById('confirmDeleteUserBtn').onclick = function() {
  if (!userIdToDelete) return;
  fetch('/delete-user', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({user_id: userIdToDelete}),
    credentials: 'same-origin'
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) {
      showNotice("XÃ³a ngÆ°á»i dÃ¹ng thÃ nh cÃ´ng!", true);
      setTimeout(() => location.reload(), 1200);
    } else {
      showNotice(data.message || "CÃ³ lá»—i xáº£y ra!", false);
    }
    closeDeleteUserModal();
  });
};
</script>
<style>
.scrollbar-thin::-webkit-scrollbar {
  width: 8px;
  height: 8px;
}
.scrollbar-thin::-webkit-scrollbar-track {
  background: #f3f4f6; /* gray-100 */
  border-radius: 10px;
}
.scrollbar-thin::-webkit-scrollbar-thumb {
  background: #cbd5e1; /* slate-300 */
  border-radius: 10px;
}
.scrollbar-thin::-webkit-scrollbar-thumb:hover {
  background: #94a3b8; /* slate-400 */
}
#activityLogContent table,
#loginLogContent table {
  width: 100%;
  border-collapse: collapse;
  min-width: 700px;
}
#activityLogContent th,
#activityLogContent td,
#loginLogContent th,
#loginLogContent td {
  padding: 0.75rem 1rem;
  border-bottom: 1px solid #e5e7eb;
  text-align: left;
  vertical-align: middle;
  white-space: nowrap;
}
#activityLogContent th,
#loginLogContent th {
  background: linear-gradient(to right, #2563eb, #38bdf8);
  color: #fff;
  font-weight: 600;
  text-align: center;
}
#activityLogContent tr:nth-child(even),
#loginLogContent tr:nth-child(even) {
  background-color: #f1f5f9;
}
#activityLogContent tr:hover,
#loginLogContent tr:hover {
  background-color: #e0e7ef;
}
@media (max-width: 900px) {
  #activityLogContent table,
  #loginLogContent table {
    min-width: 600px;
    font-size: 0.95rem;
  }
}
@media (max-width: 700px) {
  #activityLogContent table,
  #loginLogContent table {
    min-width: 400px;
    font-size: 0.9rem;
  }
  #activityLogModal .p-8,
  #loginLogModal .p-8 {
    padding: 1rem !important;
  }
}
@media (max-width: 768px) {
  #sidebar {
    position: fixed;
    top: 0;
    left: 0;
    height: 100vh;
    z-index: 50;
    width: 80vw;
    max-width: 320px;
    transform: translateX(-100%);
    transition: transform 0.3s;
    background: linear-gradient(to bottom, #2563eb, #38bdf8);
  }
  #sidebar.open {
    transform: translateX(0);
  }
  #sidebarOverlay {
    display: block;
  }
  main {
    flex-direction: column;
  }
  section {
    margin-top: 0;
  }
}
@media (max-width: 640px) {
  .modal, .max-w-md, .max-w-2xl, .max-w-3xl {
    max-width: 98vw !important;
    padding: 0.5rem !important;
  }
  .p-6, .p-8 {
    padding: 1rem !important;
  }
  .rounded-2xl, .rounded-xl {
    border-radius: 1rem !important;
  }
}
#sidebarOverlay.hidden {
  pointer-events: none;
  opacity: 0;
}
</style>
<script>
function toggleSidebar() {
  const sidebar = document.getElementById('sidebar');
  const overlay = document.getElementById('sidebarOverlay');

  const isOpen = sidebar.classList.contains('open');
  if (isOpen) {
    sidebar.classList.remove('open');
    overlay.classList.add('hidden');
  } else {
    sidebar.classList.add('open');
    overlay.classList.remove('hidden');
  }
}
// ÄÃ³ng sidebar khi chá»n menu (mobile)
document.querySelectorAll('#sidebar nav button').forEach(btn => {
  btn.addEventListener('click', () => {
    if (window.innerWidth < 768) toggleSidebar();
  });
});
</script>
<!-- Modal nháº­t kÃ½ hoáº¡t Ä‘á»™ng -->
<div id="activityLogModal" class="fixed inset-0 bg-black/40 flex items-center justify-center z-50 hidden">
  <div class="bg-white rounded-2xl shadow-2xl w-full max-w-3xl max-h-[90vh] overflow-auto p-8 flex flex-col animate-fade-in">
    <div class="flex justify-between items-center mb-6">
      <h2 class="text-2xl font-bold text-blue-700 flex items-center gap-2">
        ğŸ“œ Nháº­t kÃ½ hoáº¡t Ä‘á»™ng
      </h2>
      <button onclick="closeActivityLogModal()" class="text-gray-500 hover:text-red-500 text-3xl font-bold">&times;</button>
    </div>
    <div id="activityLogContent" class="text-gray-700 text-base min-h-[200px]">
      <div class="flex justify-center items-center h-32 text-gray-400">Äang táº£i...</div>
    </div>
  </div>
</div>
<!-- Modal nháº­t kÃ½ Ä‘Äƒng nháº­p -->
<div id="loginLogModal" class="fixed inset-0 bg-black/40 flex items-center justify-center z-50 hidden">
  <div class="bg-white rounded-2xl shadow-2xl w-full max-w-3xl max-h-[90vh] overflow-auto p-8 flex flex-col animate-fade-in">
    <div class="flex justify-between items-center mb-6">
      <h2 class="text-2xl font-bold text-green-700 flex items-center gap-2">
        ğŸ”‘ Nháº­t kÃ½ Ä‘Äƒng nháº­p
      </h2>
      <button onclick="closeLoginLogModal()" class="text-gray-500 hover:text-red-500 text-3xl font-bold">&times;</button>
    </div>
    <div id="loginLogContent" class="text-gray-700 text-base min-h-[200px]">
      <div class="flex justify-center items-center h-32 text-gray-400">Äang táº£i...</div>
    </div>
  </div>
</div>
<script>
function openActivityLogModal() {
  document.getElementById('activityLogModal').classList.remove('hidden');
  document.getElementById('activityLogContent').innerHTML = '<div class="flex justify-center items-center h-32 text-gray-400">Äang táº£i...</div>';
  fetch('/activity-log')
    .then(res => res.text())
    .then(html => { document.getElementById('activityLogContent').innerHTML = html; });
}
function closeActivityLogModal() {
  document.getElementById('activityLogModal').classList.add('hidden');
}
function openLoginLogModal() {
  document.getElementById('loginLogModal').classList.remove('hidden');
  document.getElementById('loginLogContent').innerHTML = '<div class="flex justify-center items-center h-32 text-gray-400">Äang táº£i...</div>';
  fetch('/login-log')
    .then(res => res.text())
    .then(html => { document.getElementById('loginLogContent').innerHTML = html; });
}
function closeLoginLogModal() {
  document.getElementById('loginLogModal').classList.add('hidden');
}
</script>
<!-- Modal Hoáº¡t Ä‘á»™ng thá»ƒ cháº¥t & Lá»‹ch sá»­ hoáº¡t Ä‘á»™ng -->
<div id="activityModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 hidden transition-opacity duration-300 ease-in-out">
  <div class="bg-white p-6 rounded-2xl shadow-lg w-full max-w-md space-y-4">
    <h2 class="text-2xl font-bold text-blue-600 flex items-center gap-2">
      <span>ğŸƒ</span> Ghi nháº­n hoáº¡t Ä‘á»™ng thá»ƒ cháº¥t
    </h2>
    <form id="activityForm" class="space-y-3">
      <div>
        <label for="activityType" class="block mb-1 font-medium text-gray-700">Chá»n hoáº¡t Ä‘á»™ng</label>
        <select name="activity" id="activityType" class="w-full border border-gray-300 p-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400 transition" required>
          <option value="">-- Chá»n hoáº¡t Ä‘á»™ng --</option>
          <option value="walking">ğŸš¶ Äi bá»™</option>
          <option value="running">ğŸƒ Cháº¡y bá»™</option>
          <option value="cycling">ğŸš´ Äáº¡p xe</option>
          <option value="swimming">ğŸŠ BÆ¡i lá»™i</option>
          <option value="yoga">ğŸ§˜ Yoga</option>
          <option value="weightlifting">ğŸ‹ï¸ Táº­p táº¡</option>
          <option value="jumping_rope">ğŸ¤¾ Nháº£y dÃ¢y</option>
        </select>
      </div>
      <div>
        <label for="activityDuration" class="block mb-1 font-medium text-gray-700">Thá»i gian (phÃºt)</label>
        <input name="duration" id="activityDuration" type="number" min="1" placeholder="Nháº­p sá»‘ phÃºt" class="w-full border border-gray-300 p-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400 transition" required>
      </div>
      <div class="flex justify-end gap-3 pt-2">
        <button type="button" onclick="closeActivityModal()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded-lg font-semibold transition">Huá»·</button>
        <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold transition">LÆ°u</button>
      </div>
      <div id="activityError" class="text-red-600 text-sm font-semibold"></div>
    </form>
    <div class="text-right">
      <a href="javascript:void(0)" onclick="openActivityHistoryModal()" class="text-blue-600 hover:underline text-sm">Xem lá»‹ch sá»­ hoáº¡t Ä‘á»™ng &rarr;</a>
    </div>
  </div>
</div>
<div id="activityHistoryModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
  <div class="bg-white rounded-xl shadow-lg p-6 w-full max-w-2xl">
    <h2 class="text-xl font-bold mb-4">Lá»‹ch sá»­ hoáº¡t Ä‘á»™ng thá»ƒ cháº¥t</h2>
    <div id="activityHistoryContent" class="max-h-96 overflow-y-auto"></div>
    <div class="flex justify-end mt-4">
      <button onclick="closeActivityHistoryModal()" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">ÄÃ³ng</button>
    </div>
  </div>
</div>
<script>
// Má»Ÿ modal ghi nháº­n hoáº¡t Ä‘á»™ng
function openActivityModal() {
  document.getElementById('activityModal').classList.remove('hidden');
  document.getElementById('activityForm').reset();
  document.getElementById('activityError').textContent = '';
}
// ÄÃ³ng modal ghi nháº­n hoáº¡t Ä‘á»™ng
function closeActivityModal() {
  document.getElementById('activityModal').classList.add('hidden');
}
// Xá»­ lÃ½ submit hoáº¡t Ä‘á»™ng thá»ƒ cháº¥t báº±ng AJAX
document.getElementById('activityForm').onsubmit = function(event) {
  event.preventDefault();
  const form = event.target;
  const data = new FormData(form);
  fetch('/activity', {
    method: 'POST',
    body: data,
    credentials: 'same-origin'
  })
  .then(res => {
    if (res.ok) return res.json();
    return res.json().then(err => { throw err; });
  })
  .then(result => {
    closeActivityModal();
    showNotice("Ghi nháº­n hoáº¡t Ä‘á»™ng thÃ nh cÃ´ng!", true);
  })
  .catch(err => {
    document.getElementById('activityError').textContent = err.message || "CÃ³ lá»—i xáº£y ra!";
  });
};
window.addEventListener('resize', () => {
  const sidebar = document.getElementById('sidebar');
  const overlay = document.getElementById('sidebarOverlay');
  if (window.innerWidth >= 768) {
    sidebar.classList.remove('open');
    overlay.classList.add('hidden');
  }
});
// Má»Ÿ modal lá»‹ch sá»­ hoáº¡t Ä‘á»™ng
function openActivityHistoryModal() {
  document.getElementById('activityHistoryModal').classList.remove('hidden');
  document.getElementById('activityHistoryContent').innerHTML = '<div class="text-gray-400 text-center py-8">Äang táº£i...</div>';
fetch('/activity-history')
  .then(res => res.json())
  .then(data => {
    let html = `
      <table class="min-w-full text-sm border rounded-xl overflow-hidden shadow">
        <thead>
          <tr class="bg-blue-100 text-blue-700">
            <th class="px-4 py-2">Há» tÃªn</th>
            <th class="px-4 py-2">Hoáº¡t Ä‘á»™ng</th>
            <th class="px-4 py-2">Thá»i gian</th>
            <th class="px-4 py-2">Calories</th>
          </tr>
        </thead>
        <tbody>
    `;
    if (data.error) {
      html += `<tr><td colspan="4" class="text-center text-red-500 py-4">${data.error}</td></tr>`;
    } else if (data.length === 0) {
      html += '<tr><td colspan="4" class="text-center text-gray-500 py-4">ChÆ°a cÃ³ hoáº¡t Ä‘á»™ng nÃ o</td></tr>';
    } else {
      // ...existing code...
data.forEach(act => {
  let activityName = act.activity;
  if (activityName === 'jumping_rope') activityName = 'Nháº£y dÃ¢y';
  else if (activityName === 'walking') activityName = 'Äi bá»™';
  else if (activityName === 'running') activityName = 'Cháº¡y bá»™';
  else if (activityName === 'cycling') activityName = 'Äáº¡p xe';
  else if (activityName === 'swimming') activityName = 'BÆ¡i lá»™i';
  else if (activityName === 'yoga') activityName = 'Yoga';
  else if (activityName === 'weightlifting') activityName = 'Táº­p táº¡';

  html += `<tr class="hover:bg-blue-50 transition">
    <td class="px-4 py-2">${act.fullname || ''}</td>
    <td class="px-4 py-2 capitalize">${activityName}</td>
    <td class="px-4 py-2">${act.timestamp}</td>
    <td class="px-4 py-2 font-semibold text-blue-600">${act.calories_burned} kcal</td>
  </tr>`;
});
// ...existing code...
    }
    html += '</tbody></table>';
    document.getElementById('activityHistoryContent').innerHTML = html;
  });
}
// ÄÃ³ng modal lá»‹ch sá»­ hoáº¡t Ä‘á»™ng
function closeActivityHistoryModal() {
  document.getElementById('activityHistoryModal').classList.add('hidden');
}
</script>
  </body>
</html>
