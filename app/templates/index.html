<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Nh·∫≠t K√Ω ƒÇn U·ªëng</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" /> <!-- Th√™m d√≤ng n√†y -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-100 font-sans">
  <!-- Header m·ªõi -->
<header class="relative flex flex-col sm:flex-row items-center sm:justify-between px-2 sm:px-8 py-2 sm:py-4 bg-[#fbc3bc] shadow-lg sticky top-0 z-40">
  <button id="sidebarToggleBtn"
    class="md:hidden text-white text-4xl absolute left-6 top-1/2 -translate-y-1/2 ml-2"
    onclick="toggleSidebar()">‚ò∞</button>
  <div class="flex w-full items-center justify-center sm:justify-start gap-2">
    <!-- Logo v√† t√™n app -->
    <img src="/static/logo.png"
      class="hidden sm:block w-12 h-12 rounded-full border-4 border-white shadow"
      alt="Logo" />
    <button onclick="goHome()"
  class="text-3xl sm:text-5xl font-extrabold text-white tracking-wide focus:outline-none">
  SmartCalories
</button>
  </div>
  </div>

  <!-- Ph·∫ßn avatar + t√™n + logout -->
  <div class="flex items-center gap-2 sm:gap-4 mt-2 sm:mt-0 w-full sm:w-auto justify-center sm:justify-end max-w-xs sm:max-w-md md:max-w-lg lg:max-w-xl xl:max-w-2xl">
    <img src="{{ user.avatar_url or '/static/default-avatar.png' }}"
      alt="Avatar"
      class="w-8 h-8 sm:w-10 sm:h-10 rounded-full border-2 border-white shadow" />
    <span class="text-white font-semibold text-base sm:text-lg truncate max-w-[180px] sm:max-w-[320px] md:max-w-[400px] lg:max-w-[600px]">
      {{ fullname }}
    </span>
    <a href="/logout"
      class="bg-white/20 hover:bg-white/40 text-white px-3 sm:px-4 py-1 sm:py-2 rounded-xl font-bold shadow transition flex items-center gap-2 text-base sm:text-lg">
      <span>üö™</span> <span class="hidden xs:inline">ƒêƒÉng xu·∫•t</span>
    </a>
</div>
</header>
  <!-- Dashboard layout -->
  <main class="flex flex-col md:flex-row h-auto md:h-[calc(100vh-80px)] transition-all duration-300 ease-in-out">
    <!-- Sidebar -->
<aside id="sidebar" class="w-full md:w-64 bg-[#fbc3bc] text-gray-800 p-4 space-y-2 shadow-lg fixed md:static top-0 left-0 h-full md:h-auto z-50 md:z-auto transform -translate-x-full md:translate-x-0 transition-transform duration-300 ease-in-out"
      style="max-width:100vw;">
  <div class="relative w-full">
    <button id="sidebarToggleBtn" class="md:hidden mb-4 mt-2 text-white text-4xl absolute right-4 top-2 z-20" onclick="toggleSidebar()">‚ò∞</button>
  </div>
  <nav class="flex flex-col gap-1 pt-12">
    <button onclick="switchView('meals')" id="btn-meals"
      class="flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-blue-600 transition-all duration-200 font-medium focus:outline-none">
      üìã <span>Danh s√°ch m√≥n</span>
    </button>
    {% if user.role != 'admin' %}
    <button onclick="switchView('log')" id="btn-log"
      class="flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-blue-600 transition-all duration-200 font-medium focus:outline-none">
      üìñ <span>Nh·∫≠t k√Ω & Ph√¢n t√≠ch</span>
    </button>
<button onclick="openSuggestModal()"
  class="flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-blue-600 transition-all duration-200 font-medium focus:outline-none">
  ü•ó <span>G·ª£i √Ω m√≥n ƒÉn</span>
</button>
<button onclick="openLogMealModal()"
  class="flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-blue-600 transition-all duration-200 font-medium focus:outline-none">
  üìù <span>Ghi nh·∫≠t k√Ω</span>
</button>
<button onclick="openActivityModal()"
  class="flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-blue-600 transition-all duration-200 font-medium focus:outline-none">
  üèÉ <span>Ho·∫°t ƒë·ªông th·ªÉ ch·∫•t</span>
</button>
{% endif %}
    <button onclick="openProfileModal()"
  class="flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-blue-600 transition-all duration-200 font-medium focus:outline-none">
  üë§ <span>Th√¥ng tin c√° nh√¢n</span>
</button>
{% if user.role == 'admin' %}
    <button onclick="openUserModal()"
      class="flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-blue-600 transition-all duration-200 font-medium focus:outline-none">
      üë• <span>Qu·∫£n l√Ω ng∆∞·ªùi d√πng</span>
    </button>
    {% endif %}
      {% if user.role == 'admin' %}
  <button onclick="openActivityLogModal()"
    class="flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-blue-600 transition-all duration-200 font-medium focus:outline-none">
    üìú <span>Nh·∫≠t k√Ω ho·∫°t ƒë·ªông</span>
  </button>
  <button onclick="openLoginLogModal()"
    class="flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-blue-600 transition-all duration-200 font-medium focus:outline-none">
    üîë <span>Xem ƒëƒÉng nh·∫≠p</span>
  </button>
{% endif %}
    <div class="relative group">
  <button class="flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-blue-600 transition-all duration-200 font-medium focus:outline-none w-full">
    üì§ <span>Xu·∫•t CSV</span>
  </button>
  <div class="absolute left-0 mt-1 hidden group-hover:block bg-white text-gray-800 shadow-lg rounded-lg overflow-hidden z-10 w-48">
    <a href="/export-csv?mode=today" class="block px-4 py-2 hover:bg-blue-100">üìÜ Xu·∫•t h√¥m nay</a>
    <a href="/export-csv?mode=all" class="block px-4 py-2 hover:bg-blue-100">üì¶ Xu·∫•t t·∫•t c·∫£</a>
  </div>
</div>
  </nav>
</aside>
 <!-- L·ªõp ph·ªß cho thanh b√™n tr√™n thi·∫øt b·ªã di ƒë·ªông -->
<div id="sidebarOverlay" class="fixed inset-0 bg-black/40 z-40 hidden md:hidden" onclick="toggleSidebar()"></div>
<!-- Content Area -->
<section class="flex-1 overflow-y-auto p-2 sm:p-6 mt-4 md:mt-0">
  <!-- Meals View -->
<div id="mealsView" class="hidden">
  <h2 class="text-2xl font-bold mb-4">üìã Danh s√°ch m√≥n ƒÉn</h2>
  <form method="get" action="/" class="mb-4 flex gap-2">
    <input type="text" name="search" placeholder="T√¨m m√≥n ƒÉn..." value="{{ search | default('') }}"
      class="border border-gray-300 rounded-lg px-3 py-2 w-64 focus:outline-none focus:ring-2 focus:ring-blue-400 transition" />
    <input type="hidden" name="view" value="meals" />
    <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded-lg font-semibold hover:bg-blue-600 transition">T√¨m ki·∫øm</button>
  </form>
<div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-2 sm:gap-2 md:gap-3">
      {% for meal in meals %}
  <div class="bg-white p-4 rounded-xl shadow">
    {% if meal.image_url %}
      <img src="{{ meal.image_url }}" alt="{{ meal.name }}" class="w-full h-40 object-cover rounded-lg mb-3" />
    {% else %}
      <div class="w-full h-40 bg-gray-200 rounded-lg flex items-center justify-center mb-3 text-gray-500">Kh√¥ng c√≥ ·∫£nh</div>
    {% endif %}
    <h3 class="text-lg font-semibold">{{ meal.name }}</h3>
    <ul class="flex flex-wrap gap-2 text-sm mt-2 text-gray-600">
  <li>üî• Calories: {{ meal.calories }}</li>
  <li>üí™ Protein: {{ meal.protein }}g</li>
  <li>üçû Carbs: {{ meal.carbs }}g</li>
  <li>ü•ë Fat: {{ meal.fat }}g</li>
</ul>
    <div class="mt-4 flex gap-3">
  {% if user.role == 'admin' %}
    <button class="editMealBtn text-blue-600"
        data-id="{{ meal._id }}"
        data-name="{{ meal.name }}"
        data-calories="{{ meal.calories }}"
        data-date="{{ meal.date }}">
    ‚úèÔ∏è S·ª≠a
</button>
    <button onclick="openModal('{{ meal._id }}')" class="text-red-600">üóëÔ∏è Xo√°</button>
  {% endif %}
</div>
  </div>
  {% endfor %}
</div>
        </div>

        <!-- Logs and Analytics View -->
        <div id="logView" class="hidden">
  <h2 class="text-3xl font-extrabold text-blue-700 mb-4 flex items-center gap-2">üóìÔ∏è Nh·∫≠t k√Ω h√¥m nay</h2>
  <div class="bg-white rounded-xl shadow overflow-x-auto">
    <table class="min-w-full text-sm text-gray-700">
              <thead class="bg-gradient-to-r from-blue-600 to-blue-400 text-white text-base font-semibold">
  <tr>
    <th class="p-3 text-center border border-blue-800">M√≥n</th>
    <th class="p-3 text-center border border-blue-800">S·ªë l∆∞·ª£ng</th>
    <th class="p-3 text-center border border-blue-800">Calories</th>
    <th class="p-3 text-center border border-blue-800">Protein</th>
    <th class="p-3 text-center border border-blue-800">Carbs</th>
    <th class="p-3 text-center border border-blue-800">Fat</th>
  </tr>
</thead>
<tbody>
  {% for log in logs %}
  <tr class="odd:bg-white even:bg-blue-50 hover:bg-blue-100 transition-all">
    <td class="p-3 text-center border border-blue-100 whitespace-nowrap font-medium">{{ log.meal.name }}</td>
    <td class="p-3 text-center border border-blue-100">{{ log.quantity }}</td>
    <td class="p-3 text-center border border-blue-100">{{ log.meal.calories * log.quantity }}</td>
    <td class="p-3 text-center border border-blue-100">{{ log.meal.protein * log.quantity }}</td>
    <td class="p-3 text-center border border-blue-100">{{ log.meal.carbs * log.quantity }}</td>
    <td class="p-3 text-center border border-blue-100">{{ log.meal.fat * log.quantity }}</td>
  </tr>
  {% endfor %}
</tbody>
            </table>
          </div>

          <h2 class="text-3xl font-extrabold text-green-700 mt-10 mb-4 flex items-center gap-2">üìä Ph√¢n t√≠ch h√¥m nay</h2>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
  <div class="bg-white p-6 rounded-2xl shadow-xl hover:shadow-2xl transition">
    <h3 class="text-lg font-semibold mb-4 text-gray-700">üìà Dinh d∆∞·ª°ng t·ªïng</h3>
    <canvas id="nutritionChart" class="h-64 w-full"></canvas>
  </div>
  <div class="bg-white p-6 rounded-2xl shadow-xl hover:shadow-2xl transition">
    <h3 class="text-lg font-semibold mb-4 text-gray-700">ü•ó Ph√¢n b·ªë ch·∫•t</h3>
    <canvas id="macroPieChart" class="max-w-full h-64"></canvas>
  </div>
</div>
        </div>
        <div id="welcomeView" class="flex flex-col items-center justify-center h-full text-center text-gray-700 space-y-4">
  <img src="/static/trangchu.png" alt="Welcome" class="w-40 h-40">
  <h1 class="text-3xl font-bold">Ch√†o m·ª´ng ƒë·∫øn v·ªõi SmartCalories! ü•ó</h1>
  <p class="text-lg">H√£y ch·ªçn m·ªôt m·ª•c t·ª´ menu b√™n tr√°i ƒë·ªÉ b·∫Øt ƒë·∫ßu qu·∫£n l√Ω kh·∫©u ph·∫ßn ƒÉn c·ªßa b·∫°n.</p>
</div>
      </section>
    </main>
<script>
  window.mealsData = {{ meals | tojson | safe }};
  window.logsData = {{ logs | tojson | safe }};
  window.summary = {{ summary | tojson | safe }};
  window.activitiesData = {{ activities | tojson | safe }};
</script>
    <!-- JS Script -->
    <script>
      const summary = {
        calories: {{ summary.total_calories | default(0) }},
        protein: {{ summary.total_protein | default(0) }},
        carbs: {{ summary.total_carbs | default(0) }},
        fat: {{ summary.total_fat | default(0) }},
      };

      function switchView(view) {
        document.getElementById("mealsView").classList.add("hidden");
        document.getElementById("logView").classList.add("hidden");
        document.getElementById(view + "View").classList.remove("hidden");
      }

      window.onload = () => {
    // ·∫®n t·∫•t c·∫£ view ban ƒë·∫ßu
    document.getElementById("mealsView").classList.add("hidden");
    document.getElementById("logView").classList.add("hidden");
  };

      new Chart(document.getElementById("nutritionChart"), {
  type: 'bar',
  data: {
    labels: ['Calories', 'Protein', 'Carbs', 'Fat'],
    datasets: [{
      label: 'Dinh d∆∞·ª°ng h√¥m nay',
      data: [summary.calories, summary.protein, summary.carbs, summary.fat],
      backgroundColor: [
        'rgba(255,99,132,0.8)',  // ƒë·ªè
        'rgba(54,162,235,0.8)',  // xanh d∆∞∆°ng
        'rgba(255,206,86,0.8)',  // v√†ng
        'rgba(75,192,192,0.8)'   // xanh l√°
      ],
      hoverBackgroundColor: [
        'rgba(255,99,132,1)',
        'rgba(54,162,235,1)',
        'rgba(255,206,86,1)',
        'rgba(75,192,192,1)'
      ],
      borderRadius: 12,
      borderWidth: 1
    }]
  },
  options: {
    responsive: true,
    plugins: {
      legend: { display: false },
      tooltip: {
        backgroundColor: '#1f2937',
        titleFont: { weight: 'bold', size: 14 },
        bodyFont: { size: 13 },
        padding: 10,
        callbacks: {
          label: function(ctx) {
            return `${ctx.label}: ${ctx.parsed.y} ${ctx.label === 'Calories' ? 'kcal' : 'g'}`;
          }
        }
      }
    },
    scales: {
      x: {
        grid: { display: false },
        ticks: { font: { size: 16, weight: 'bold' }, color: '#374151' }
      },
      y: {
        beginAtZero: true,
        grid: { color: '#e5e7eb' },
        ticks: { font: { size: 14 }, color: '#4b5563' }
      }
    }
  }
});


  // Macro Pie Chart
  new Chart(document.getElementById("macroPieChart"), {
  type: 'doughnut',
  data: {
    labels: ['Protein', 'Carbs', 'Fat'],
    datasets: [{
      data: [summary.protein, summary.carbs, summary.fat],
      backgroundColor: [
        'rgba(59,130,246,0.9)', // xanh d∆∞∆°ng
        'rgba(253,224,71,0.9)', // v√†ng
        'rgba(52,211,153,0.9)'  // xanh l√°
      ],
      hoverOffset: 14,
      borderColor: ['#2563eb', '#ca8a04', '#059669'],
      borderWidth: 2
    }]
  },
  options: {
    responsive: true,
    cutout: '65%',
    plugins: {
      legend: {
        display: true,
        position: 'bottom',
        labels: {
          font: { size: 15, weight: 'bold' },
          color: '#374151'
        }
      },
      tooltip: {
        callbacks: {
          label: function(ctx) {
            const total = ctx.dataset.data.reduce((a, b) => a + b, 0);
            const value = ctx.parsed;
            const percent = total ? ((value / total) * 100).toFixed(1) : 0;
            return `${ctx.label}: ${value}g (${percent}%)`;
          }
        }
      }
    }
  }
});
</script>
    <!-- Modal Ghi Nh·∫≠t K√Ω -->
  <div id="logMealModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 hidden transition-opacity duration-300 ease-in-out">
    <div class="bg-white p-6 rounded-2xl shadow-lg w-full max-w-md space-y-4">
      <h2 class="text-2xl font-bold text-green-600 flex items-center gap-2">
        <span>üìù</span> Ghi nh·∫≠t k√Ω
      </h2>
      <form action="/log-meal" method="POST" class="space-y-3">
        <select name="meal_id" class="w-full border border-gray-300 p-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-400 transition" required>
          {% for meal in meals %}
          <option value="{{ meal._id }}">{{ meal.name }}</option>
          {% endfor %}
        </select>
        <input name="quantity" type="number" placeholder="S·ªë l∆∞·ª£ng" class="w-full border border-gray-300 p-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-400 transition" required>
        <input name="date" type="date" value="{{ today }}" class="w-full border border-gray-300 p-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-400 transition" required>
        <div class="flex justify-end gap-3 pt-2">
          <button type="button" onclick="closeLogMealModal()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded-lg font-semibold transition">Hu·ª∑</button>
          <button type="submit" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg font-semibold transition">L∆∞u</button>
        </div>
      </form>
    </div>
  </div>
  <script>
    function openLogMealModal() {
      document.getElementById('logMealModal').classList.remove('hidden');
    }
    function closeLogMealModal() {
      document.getElementById('logMealModal').classList.add('hidden');
    }
  </script>
  <!-- Modal Th√™m M√≥n ƒÇn -->
  <div id="addMealModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 hidden transition-opacity duration-300 ease-in-out">
    <div class="bg-white p-6 rounded-2xl shadow-lg w-full max-w-md space-y-4">
      <h2 class="text-2xl font-bold text-blue-600 flex items-center gap-2">
        <span>‚ûï</span> Th√™m m√≥n ƒÉn
      </h2>
      <form action="/add-meal" method="POST" class="space-y-3">
        <div>
          <label for="addName" class="block mb-1 font-medium text-gray-700">T√™n m√≥n</label>
          <input name="name" id="addName" placeholder="T√™n m√≥n ƒÉn" class="w-full border border-gray-300 p-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400 transition" required>
        </div>
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label for="addCalories" class="block mb-1 font-medium text-gray-700">Calories</label>
            <input name="calories" id="addCalories" type="number" placeholder="Calories" class="w-full border border-gray-300 p-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400 transition" required>
          </div>
          <div>
            <label for="addProtein" class="block mb-1 font-medium text-gray-700">Protein (g)</label>
            <input name="protein" id="addProtein" type="number" placeholder="Protein (g)" class="w-full border border-gray-300 p-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400 transition" required>
          </div>
          <div>
            <label for="addCarbs" class="block mb-1 font-medium text-gray-700">Carbs (g)</label>
            <input name="carbs" id="addCarbs" type="number" placeholder="Carbs (g)" class="w-full border border-gray-300 p-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400 transition" required>
          </div>
          <div>
            <label for="addFat" class="block mb-1 font-medium text-gray-700">Fat (g)</label>
            <input name="fat" id="addFat" type="number" placeholder="Fat (g)" class="w-full border border-gray-300 p-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400 transition" required>
          </div>
        </div>
        <div class="flex justify-end gap-3 pt-2">
          <button type="button" onclick="closeAddMealModal()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded-lg font-semibold transition">Hu·ª∑</button>
          <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold transition">Th√™m</button>
        </div>
        <div>
  <label for="addImageUrl" class="block mb-1 font-medium text-gray-700">Link ·∫£nh (tu·ª≥ ch·ªçn)</label>
  <input name="image_url" id="addImageUrl" type="url" placeholder="https://..." class="w-full border border-gray-300 p-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400 transition">
</div>
      </form>
    </div>
  </div>
  <script>
    function openAddMealModal() {
      document.getElementById('addMealModal').classList.remove('hidden');
    }
    function closeAddMealModal() {
      document.getElementById('addMealModal').classList.add('hidden');
    }
  </script>
  <!-- Modal s·ª≠a m√≥n ƒÉn -->
  <div id="editMealModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 hidden transition-opacity duration-300 ease-in-out">
    <div class="bg-white p-6 rounded-2xl shadow-lg w-full max-w-md space-y-4">
      <h2 class="text-2xl font-bold text-blue-600 flex items-center gap-2">
        <span>‚úèÔ∏è</span> S·ª≠a m√≥n ƒÉn
      </h2>
      <form id="editMealForm" method="POST" class="space-y-3">
        <input type="hidden" name="meal_id" id="editMealId" />
        <div>
          <label for="editName" class="block mb-1 font-medium text-gray-700">T√™n m√≥n</label>
          <input type="text" id="editName" name="name" class="w-full border border-gray-300 p-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400 transition" required />
        </div>
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label for="editCalories" class="block mb-1 font-medium text-gray-700">Calories</label>
            <input type="number" id="editCalories" name="calories" class="w-full border border-gray-300 p-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400 transition" required />
          </div>
          <div>
            <label for="editProtein" class="block mb-1 font-medium text-gray-700">Protein (g)</label>
            <input type="number" id="editProtein" name="protein" class="w-full border border-gray-300 p-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400 transition" required />
          </div>
          <div>
            <label for="editCarbs" class="block mb-1 font-medium text-gray-700">Carbs (g)</label>
            <input type="number" id="editCarbs" name="carbs" class="w-full border border-gray-300 p-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400 transition" required />
          </div>
          <div>
            <label for="editFat" class="block mb-1 font-medium text-gray-700">Fat (g)</label>
            <input type="number" id="editFat" name="fat" class="w-full border border-gray-300 p-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400 transition" required />
          </div>
        </div>
        <div class="flex justify-end gap-3 pt-2">
          <button type="button" onclick="closeEditMealModal()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded-lg font-semibold transition">Hu·ª∑</button>
          <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold transition">L∆∞u</button>
        </div>
        <div>
  <label for="editImageUrl" class="block mb-1 font-medium text-gray-700">Link ·∫£nh (tu·ª≥ ch·ªçn)</label>
  <input type="url" id="editImageUrl" name="image_url" class="w-full border border-gray-300 p-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400 transition" />
</div>
      </form>
    </div>
  </div>
  <script>
    function openEditMealModal(meal) {
      document.getElementById('editMealId').value = meal._id;
      document.getElementById('editName').value = meal.name;
      document.getElementById('editCalories').value = meal.calories;
      document.getElementById('editProtein').value = meal.protein;
      document.getElementById('editCarbs').value = meal.carbs;
      document.getElementById('editFat').value = meal.fat;
      document.getElementById('editImageUrl').value = meal.image_url || ""; 
      document.getElementById('editMealForm').action = '/edit-meal/' + meal._id;
      document.getElementById('editMealModal').classList.remove('hidden');
    }
    document.querySelectorAll('.editMealBtn').forEach(btn => {
      btn.addEventListener('click', () => {
        const meal = JSON.parse(btn.dataset.meal);
        openEditMealModal(meal);
      });
    });
    function closeEditMealModal() {
      document.getElementById('editMealModal').classList.add('hidden');
    }
  </script>
  <!-- Modal x√°c nh·∫≠n xo√° -->
  <div id="deleteModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg shadow-lg p-6 w-full max-w-sm">
      <h2 class="text-xl font-semibold mb-4">üóëÔ∏è X√°c nh·∫≠n xo√°</h2>
      <p class="text-gray-700 mb-4">B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën xo√° m√≥n ƒÉn n√†y?</p>
      <div class="flex justify-end gap-3">
        <button onclick="closeModal()" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded">Hu·ª∑</button>
        <form id="confirmDeleteForm" method="POST">
          <button type="submit" class="px-4 py-2 bg-red-500 text-white hover:bg-red-600 rounded">Xo√°</button>
        </form>
      </div>
    </div>
  </div>
  <script>
    function openModal(mealId) {
      const modal = document.getElementById("deleteModal");
      const form = document.getElementById("confirmDeleteForm");
      form.action = "/delete-meal/" + mealId;
      modal.classList.remove("hidden");
    }
    function closeModal() {
      document.getElementById("deleteModal").classList.add("hidden");
    }
  </script>
  <!-- Modal G·ª£i √Ω m√≥n ƒÉn -->
<div id="suggestModal" class="fixed inset-0 bg-black/40 flex items-center justify-center z-50 hidden">
  <div class="bg-white rounded-xl shadow-lg w-full max-w-md mx-auto max-h-[95vh] p-4 sm:p-6 flex flex-col overflow-y-auto">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-xl font-bold text-yellow-700 flex items-center gap-2">
        ü•ó G·ª£i √Ω m√≥n ƒÉn & ƒê·∫∑t m·ª•c ti√™u
      </h2>
      <button onclick="closeSuggestModal()" class="text-gray-500 hover:text-red-500 text-2xl font-bold">&times;</button>
    </div>
    <!-- Form ƒë·∫∑t m·ª•c ti√™u -->
<!-- Form ƒë·∫∑t m·ª•c ti√™u -->
<form method="post" action="/set-goals"
  class="flex flex-col sm:flex-row sm:items-end gap-1 sm:gap-2 mb-2 bg-blue-50 p-1 sm:p-2 rounded-lg shadow w-full"
  id="goalsForm"
  onsubmit="return submitGoalsForm(event)">
  <div class="flex-1 min-w-0">
    <label class="block text-[11px] font-bold mb-0.5">Calories</label>
    <input type="number" name="calories" value="0" min="0" class="border rounded px-1 py-0.5 w-full text-xs" required />
  </div>
  <div class="flex-1 min-w-0">
    <label class="block text-[11px] font-bold mb-0.5">Protein</label>
    <input type="number" name="protein" value="0" min="0" class="border rounded px-1 py-0.5 w-full text-xs" required />
  </div>
  <div class="flex-1 min-w-0">
    <label class="block text-[11px] font-bold mb-0.5">Carbs</label>
    <input type="number" name="carbs" value="0" min="0" class="border rounded px-1 py-0.5 w-full text-xs" required />
  </div>
  <div class="flex-1 min-w-0">
    <label class="block text-[11px] font-bold mb-0.5">Fat</label>
    <input type="number" name="fat" value="0" min="0" class="border rounded px-1 py-0.5 w-full text-xs" required />
  </div>
  <button type="submit" class="bg-blue-500 text-white px-2 py-1 rounded font-bold text-xs w-full sm:w-auto mt-1 sm:mt-0">L∆∞u</button>
</form>
    <!-- Th√¥ng b√°o l∆∞·ª£ng c√≤n thi·∫øu -->
    <div class="mb-3 text-sm text-gray-700">
      ƒêang thi·∫øu:
      <span class="font-semibold text-red-600" id="missingCalories">Calories: {{ missing.calories }}</span>,
      <span class="font-semibold text-blue-600" id="missingProtein">Protein: {{ missing.protein }}</span>,
      <span class="font-semibold text-yellow-600" id="missingCarbs">Carbs: {{ missing.carbs }}</span>,
      <span class="font-semibold text-green-600" id="missingFat">Fat: {{ missing.fat }}</span>
    </div>
    <!-- G·ª£i √Ω m√≥n ƒÉn -->
    <div class="overflow-y-auto space-y-4 pr-2" id="suggestedMealGroups" style="max-height: 40vh;"></div>
    <div class="text-xs text-gray-500 mt-2">* G·ª£i √Ω d·ª±a tr√™n ch·∫•t c√≤n thi·∫øu nhi·ªÅu nh·∫•t h√¥m nay</div>
  </div>
</div>
<script>
  function openSuggestModal() {
  document.getElementById('suggestModal').classList.remove('hidden');
  document.querySelector('input[name="calories"]').value = 0;
  document.querySelector('input[name="protein"]').value = 0;
  document.querySelector('input[name="carbs"]').value = 0;
  document.querySelector('input[name="fat"]').value = 0;
  // Reset c√°c gi√° tr·ªã "ƒêang thi·∫øu" v·ªÅ 0
  document.getElementById('missingCalories').textContent = "Calories: 0";
  document.getElementById('missingProtein').textContent = "Protein: 0";
  document.getElementById('missingCarbs').textContent = "Carbs: 0";
  document.getElementById('missingFat').textContent = "Fat: 0";
  // Xo√° g·ª£i √Ω m√≥n ƒÉn c≈©
  document.getElementById('suggestedMealGroups').innerHTML = "";
}
  // N·∫øu mu·ªën submit form kh√¥ng reload trang, c√≥ th·ªÉ d√πng AJAX ·ªü ƒë√¢y
</script>
<script>
  function openSuggestModal() {
    document.getElementById('suggestModal').classList.remove('hidden');
  }
  function closeSuggestModal() {
    document.getElementById('suggestModal').classList.add('hidden');
  }
</script>
<!-- Chatbot Floating Button & Modal -->
<style>
#chatbot-float-btn {
  position: fixed;
  bottom: 28px;
  right: 28px;
  z-index: 9999;
  background: linear-gradient(90deg,#FF6F61,#FF8A80);
  color: #fff;
  border: none;
  border-radius: 50%;
  width: 60px; height: 60px;
  box-shadow: 0 4px 16px #0002;
  font-size: 2rem;
  display: flex; align-items: center; justify-content: center;
  cursor: pointer;
  transition: background 0.2s;
}
#chatbot-float-btn:hover { background: linear-gradient(90deg,#FF8A80,#FF6F61);}
#chatbot-modal {
  position: fixed;
  bottom: 100px;
  right: 32px;
  width: 300px;
  max-width: 95vw;
  height: 400px;
  background: #fff;
  border-radius: 18px;
  box-shadow: 0 8px 32px #0003;
  z-index: 9999;
  display: none;
  flex-direction: column;
  overflow: hidden;
  border: 2px solid #FF8A80;
}
#chatbot-modal.open { display: flex; }
#chatbot-header {
  background: linear-gradient(90deg,#FF6F61,#FF8A80);
  color: #fff;
  padding: 14px 18px;
  font-weight: bold;
  font-size: 1.1rem;
  display: flex;
  align-items: center;
  justify-content: space-between;
}
#chatbot-close-btn {
  background: none;
  border: none;
  color: #fff;
  font-size: 1.5rem;
  cursor: pointer;
}
#chatbot-messages {
  flex: 1;
  padding: 16px;
  overflow-y: auto;
  background: #fff7f6;
 font-size: 0.95rem; /* nh·ªè h∆°n m·∫∑c ƒë·ªãnh */
  line-height: 1.5;
}
.chatbot-msg {
  margin-bottom: 12px;
  display: flex;
  flex-direction: column;
  align-items: flex-start;
}
.chatbot-msg.user {
  align-items: flex-end;
}
.chatbot-msg .bubble {
  font-size: 0.97rem; 
  padding: 8px 14px;
  border-radius: 10px;
  margin-bottom: 4px;
  word-break: break-word;
  white-space: pre-line; 
}
.chatbot-msg.user .bubble {
  background: #FF8A80;
  color: #fff;
  border-bottom-right-radius: 4px;
}
.chatbot-msg.bot .bubble {
  background: #fbc3bc;
  color: #222;
  border-bottom-left-radius: 4px;
}
#chatbot-input-area {
  display: flex;
  border-top: 1px solid #fbc3bc;
  background: #fff;
  padding: 10px;
  gap: 8px;
}
#chatbot-input {
  flex: 1;
  border: 1px solid #fbc3bc;
  border-radius: 8px;
  padding: 8px 12px;
  font-size: 1rem;
  outline: none;
}
#chatbot-send-btn {
  background: linear-gradient(90deg,#FF6F61,#FF8A80);
  color: #fff;
  border: none;
  border-radius: 8px;
  padding: 0 18px;
  font-size: 1.1rem;
  font-weight: bold;
  cursor: pointer;
  transition: background 0.2s;
}
#chatbot-send-btn:disabled { opacity: 0.5; cursor: not-allowed; }
@media (max-width: 500px) {
  #chatbot-modal { right: 2vw; width: 98vw; }
}
</style>
{% if user.role != 'admin' %}
<button id="chatbot-float-btn" title="Chat v·ªõi SmartCalories">üí¨</button>
<div id="chatbot-modal">
  <div id="chatbot-header">
    <span style="font-weight:bold;color:#f5f2f2;font-size:1.1rem;">SmartCalories Chatbot</span>
    <button id="chatbot-close-btn" style="float:right;font-size:1.2rem;background:none;border:none;cursor:pointer;"></button>
  </div>
  <div id="chatbot-messages" style="flex:1;overflow-y:auto;padding:12px 8px 0 8px;max-height:350px;"></div>
  <form id="chatbot-input-area" autocomplete="off">
    <input id="chatbot-input" type="text" placeholder="H·ªèi v·ªÅ m√≥n ƒÉn, dinh d∆∞·ª°ng, g·ª£i √Ω th·ª±c ƒë∆°n..." required />
    <button id="chatbot-send-btn" type="submit">G·ª≠i</button>
  </form>
</div>
<script>
const chatbotBtn = document.getElementById('chatbot-float-btn');
const chatbotModal = document.getElementById('chatbot-modal');
const chatbotClose = document.getElementById('chatbot-close-btn');
const chatbotMessages = document.getElementById('chatbot-messages');
const chatbotInput = document.getElementById('chatbot-input');
const chatbotSendBtn = document.getElementById('chatbot-send-btn');

let chatbotHistory = [
  {role: "system", content: "B·∫°n l√† tr·ª£ l√Ω dinh d∆∞·ª°ng."},
  {role: "assistant", content: "Xin ch√†o! T√¥i l√† tr·ª£ l√Ω Gemini chuy√™n v·ªÅ nh·∫≠t k√Ω ƒÉn u·ªëng v√† dinh d∆∞·ª°ng. B·∫°n c·∫ßn h·ªèi g√¨?"}
];

function renderChatbotHistory() {
  chatbotMessages.innerHTML = '';
  chatbotHistory.forEach(msg => {
    if (msg.role === 'system') return;
    appendMsg(msg.role === 'assistant' ? 'bot' : 'user', msg.content);
  });
  chatbotMessages.scrollTop = chatbotMessages.scrollHeight;
}

chatbotBtn.onclick = () => {
  if (chatbotModal.classList.contains('open')) {
    chatbotModal.classList.remove('open');
  } else {
    chatbotModal.classList.add('open');
    setTimeout(() => {
      renderChatbotHistory();
      chatbotInput.focus();
    }, 50);
  }
};

chatbotClose.onclick = () => chatbotModal.classList.remove('open');

function appendMsg(role, text) {
  const msg = document.createElement('div');
  msg.className = 'chatbot-msg ' + (role === 'user' ? 'user' : 'bot');
  const bubble = document.createElement('div');
  bubble.className = 'bubble';
  bubble.innerHTML = text
    .replace(/\*\*(.*?)\*\*/g, '<b>$1</b>')
    .replace(/^\s*\*\s+/gm, '‚Ä¢ ') 
    .replace(/\n/g, "<br>");
  msg.appendChild(bubble);
  chatbotMessages.appendChild(msg);
  chatbotMessages.scrollTop = chatbotMessages.scrollHeight;
}
document.getElementById('chatbot-input-area').onsubmit = async function(e) {
  e.preventDefault();
  const text = chatbotInput.value.trim();
  if (!text) return;

  chatbotHistory.push({role: "user", content: text});
  appendMsg('user', text);
  chatbotInput.value = '';
  chatbotSendBtn.disabled = true;

  // Hi·ªán "ƒêang tr·∫£ l·ªùi..."
const loadingMsg = document.createElement('div');
loadingMsg.className = 'chatbot-msg bot';
const loadingBubble = document.createElement('div');
loadingBubble.className = 'bubble';
loadingBubble.textContent = 'ƒêang tr·∫£ l·ªùi...';
loadingMsg.appendChild(loadingBubble);
chatbotMessages.appendChild(loadingMsg);
chatbotMessages.scrollTop = chatbotMessages.scrollHeight;

  try {
    // L·∫•y danh s√°ch m√≥n ƒÉn t·ª´ bi·∫øn mealsData do backend render ra
    const res = await fetch('/chatbot', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        messages: chatbotHistory,
        meals: window.mealsData || [],
        logs: window.logsData || [],
        summary: window.summary || {},
        activities: window.activitiesData || []
      }),
      credentials: 'same-origin'
    });

    const data = await res.json();
    loadingMsg.remove(); // Xo√° "ƒêang tr·∫£ l·ªùi..."
    const reply = data.reply || 'Xin l·ªói, t√¥i ch∆∞a c√≥ c√¢u tr·∫£ l·ªùi.';
    chatbotHistory.push({role: "assistant", content: reply});
    appendMsg('bot', reply);
  } catch (err) {
    loadingMsg.remove();
    appendMsg('bot', '‚ùå L·ªói k·∫øt n·ªëi ƒë·∫øn m√°y ch·ªß.');
  }

  chatbotSendBtn.disabled = false;
};
</script>
{% endif %}
<style>
.sidebar.collapsed > *:not(#sidebarToggleBtn):not(.w-full) {
  display: none !important;
}
.sidebar.collapsed .w-full > *:not(img) {
  display: none !important;
}
.sidebar.collapsed .w-full img {
  width: 2.5rem !important;
  height: 2.5rem !important;
}
.sidebar.collapsed {
  width: 4rem !important;
  padding-left: 0.5rem !important;
  padding-right: 0.5rem !important;
  overflow: hidden !important;
}
.sidebar.collapsed nav {
  display: none !important;
}
.sidebar.collapsed button[onclick*="toggleSidebar"] {
  left: 40px !important;
  right: auto !important;
}
  /* Khi sidebar b·ªã collapse */
  #sidebar.collapsed {
    width: 4rem; /* w-16 */
  }
  #sidebar.collapsed .sidebar-text {
    display: none;
  }
  .sidebar-btn {
  @apply flex items-center gap-3 px-4 py-3 rounded-xl font-semibold text-white bg-gradient-to-r from-blue-400 to-green-400 shadow hover:from-green-400 hover:to-blue-400 hover:scale-105 transition-all duration-200;
  margin-bottom: 0.25rem;
  border: none;
  outline: none;
  cursor: pointer;
}
.sidebar-btn:active {
  @apply scale-95;
}
.sidebar-btn .sidebar-text {
  @apply transition-all duration-200;
}
.sidebar.collapsed .sidebar-text {
  display: none !important;
}
.sidebar.collapsed .sidebar-btn {
  justify-content: center;
  padding-left: 0.5rem;
  padding-right: 0.5rem;
}
.sidebar.collapsed .w-full > *:not(img) {
  display: none !important;
}
.sidebar.collapsed .w-full img {
  width: 2.5rem !important;
  height: 2.5rem !important;
}
.sidebar.collapsed {
  width: 4rem !important;
  padding-left: 0.5rem !important;
  padding-right: 0.5rem !important;
  overflow: hidden !important;
}
.sidebar.collapsed nav {
  display: block !important;
}

#sidebar.collapsed {
  width: 4rem;
}
#sidebar.collapsed .sidebar-text {
  display: none;
}
  .sidebar-btn {
    @apply flex items-center gap-3 px-4 py-3 rounded-xl text-white font-medium transition-all duration-200 ease-in-out hover:bg-blue-500/50 focus:outline-none;
  }
  .sidebar-btn.active {
    @apply bg-white text-blue-700 shadow-md font-semibold;
  }
  .sidebar-text {
    @apply whitespace-nowrap;
  }
@media (max-width: 640px) {
  #profileModal .bg-white {
    max-width: 98vw !important;
    padding: 0.5rem !important;
  }
  #profileForm {
    padding: 0 !important;
    max-width: 100vw !important;
  }
  #profileForm input,
  #profileForm select {
    font-size: 15px !important;
    padding: 0.5rem !important;
  }
}
.fe-bold { font-weight: bold; color: #FF6F61; }
</style>
<script>
  function switchView(view) {
    // ·∫®n t·∫•t c·∫£ view
    document.getElementById("welcomeView").classList.add("hidden");
    document.getElementById("mealsView").classList.add("hidden");
    document.getElementById("logView").classList.add("hidden");

    // Hi·ªán view t∆∞∆°ng ·ª©ng
    document.getElementById(view + "View").classList.remove("hidden");

    // C·∫≠p nh·∫≠t tr·∫°ng th√°i active cho sidebar
    document.querySelectorAll("aside button").forEach(btn => {
      btn.classList.remove("bg-white", "text-blue-700", "font-semibold", "shadow-md");
    });
    const activeBtn = document.getElementById("btn-" + view);
    if (activeBtn) {
      activeBtn.classList.add("bg-white", "text-blue-700", "font-semibold", "shadow-md");
    }
  }

  function goHome() {
    // ·∫®n t·∫•t c·∫£
    document.getElementById("mealsView").classList.add("hidden");
    document.getElementById("logView").classList.add("hidden");
    document.getElementById("welcomeView").classList.remove("hidden");

    // Xo√° tr·∫°ng th√°i active
    document.querySelectorAll("aside button").forEach(btn => {
      btn.classList.remove("bg-white", "text-blue-700", "font-semibold", "shadow-md");
    });
  }

  window.onload = () => {
    const params = new URLSearchParams(window.location.search);
    const view = params.get("view");

    document.getElementById("mealsView").classList.add("hidden");
    document.getElementById("logView").classList.add("hidden");
    document.getElementById("welcomeView").classList.add("hidden");

    if (view === "log") {
      switchView("log");
    } else if (view === "meals") {
      switchView("meals");
    } else {
      document.getElementById("welcomeView").classList.remove("hidden");
    }
  };
</script>
<script>
function submitGoalsForm(event) {
  event.preventDefault();
  const form = document.getElementById('goalsForm');
  const formData = new FormData(form);

  fetch('/set-goals', {
    method: 'POST',
    body: formData,
    credentials: 'same-origin'
  })
  .then(res => res.json())
  .then(data => {
    // C·∫≠p nh·∫≠t l∆∞·ª£ng c√≤n thi·∫øu
    document.getElementById('missingCalories').textContent = "Calories: " + data.missing.calories;
    document.getElementById('missingProtein').textContent = "Protein: " + data.missing.protein;
    document.getElementById('missingCarbs').textContent = "Carbs: " + data.missing.carbs;
    document.getElementById('missingFat').textContent = "Fat: " + data.missing.fat;

    const container = document.getElementById('suggestedMealGroups');
    container.innerHTML = "";

    const nutrientLabels = {
      calories: "üçö Calories",
      protein: "üí™ Protein",
      carbs: "üçû Carbs",
      fat: "ü•ë Fat"
    };

    Object.keys(data.suggested_meals).forEach(nutrient => {
      const group = document.createElement('div');

      const toggleBtn = document.createElement('button');
      toggleBtn.textContent = `·∫®n/Hi·ªán g·ª£i √Ω ${nutrientLabels[nutrient]}`;
      toggleBtn.className = "mb-2 text-sm font-semibold bg-yellow-200 px-3 py-1 rounded shadow hover:bg-yellow-300";
      
      const list = document.createElement('div');
      list.className = "grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4";
      list.id = `group-${nutrient}`;

      toggleBtn.onclick = () => {
        list.classList.toggle("hidden");
      };

      const title = document.createElement('div');
      title.className = "font-semibold text-yellow-700 mt-2 mb-1";
      title.textContent = `G·ª£i √Ω theo ${nutrientLabels[nutrient]} c√≤n thi·∫øu:`;

      const meals = data.suggested_meals[nutrient];
      if (meals.length === 0) {
        const msg = document.createElement("div");
        msg.className = "text-gray-500 italic col-span-3";
        msg.textContent = "Kh√¥ng c√≥ m√≥n ph√π h·ª£p.";
        list.appendChild(msg);
      } else {
        meals.forEach(meal => {
          const card = document.createElement("div");
          card.className = "bg-yellow-50 p-3 rounded-lg shadow text-center";

          if (meal.image_url) {
            const img = document.createElement("img");
            img.src = meal.image_url + "?t=" + new Date().getTime();
            img.alt = meal.name;
            img.className = "w-full h-24 object-cover rounded mb-2";
            card.appendChild(img);
          }

          const name = document.createElement("div");
          name.className = "font-bold text-blue-700 mb-1";
          name.textContent = meal.name;
          card.appendChild(name);

          const info = document.createElement("div");
          info.className = "text-sm text-gray-600";
          info.innerHTML = `üî• ${meal.calories} cal<br>üí™ ${meal.protein}g ‚Ä¢ üçû ${meal.carbs}g ‚Ä¢ ü•ë ${meal.fat}g`;
          card.appendChild(info);

          list.appendChild(card);
        });
      }

      group.appendChild(toggleBtn);
      group.appendChild(title);
      group.appendChild(list);
      container.appendChild(group);
    });
  });

  return false;
}
</script>
<script>
  // L·∫•y th√¥ng tin user t·ª´ backend (Jinja2)
  const userProfile = {
  fullname: "{{ fullname }}",
  email: "{{ user.email or '' }}",
  height: {{ user.height if user and user.height is defined else 'null' }},
  weight: {{ user.weight if user and user.weight is defined else 'null' }},
  age: {{ user.age if user and user.age is defined else 'null' }},
  gender: "{{ user.gender if user and user.gender is defined else '' }}",
  bmr: {{ bmr if bmr is defined and bmr else 'null' }},
  tdee: {{ tdee if tdee is defined and tdee else 'null' }},
  avatar_url: "{{ user.avatar_url or '' }}"
  };

  function openProfileModal() {
  document.getElementById('profileModal').classList.remove('hidden');
  switchToViewProfile();
  document.getElementById('viewFullname').textContent = userProfile.fullname || '';
  document.getElementById('viewHeight').textContent = userProfile.height || 'Ch∆∞a c·∫≠p nh·∫≠t';
  document.getElementById('viewWeight').textContent = userProfile.weight || 'Ch∆∞a c·∫≠p nh·∫≠t';
  document.getElementById('viewAge').textContent = userProfile.age || 'Ch∆∞a c·∫≠p nh·∫≠t';
  document.getElementById('viewGender').textContent = userProfile.gender === 'male' ? 'Nam' : (userProfile.gender === 'female' ? 'N·ªØ' : 'Ch∆∞a c·∫≠p nh·∫≠t');
  document.getElementById('viewEmail').textContent = userProfile.email || 'Ch∆∞a c·∫≠p nh·∫≠t';
  document.getElementById('viewBmr').textContent = userProfile.bmr || 'Ch∆∞a c√≥';
  document.getElementById('viewTdee').textContent = userProfile.tdee || 'Ch∆∞a c√≥';
  document.getElementById('viewAvatar').src = userProfile.avatar_url || '';

}
  function closeProfileModal() {
    document.getElementById('profileModal').classList.add('hidden');
  }
  function switchToEditProfile() {
    document.getElementById('profileViewMode').classList.add('hidden');
    document.getElementById('profileForm').classList.remove('hidden');
    document.getElementById('profileHeight').value = userProfile.height || '';
    document.getElementById('profileWeight').value = userProfile.weight || '';
    document.getElementById('profileAge').value = userProfile.age || '';
    document.getElementById('profileGender').value = userProfile.gender || 'male';
    document.getElementById('profileEmail').value = userProfile.email || '';
    document.getElementById('profileAvatarFile').value = '';
  }
document.getElementById('profileAvatarFile').addEventListener('change', function (e) {
  const file = e.target.files[0];
  if (file) {
    const reader = new FileReader();
    reader.onload = function (ev) {
      document.getElementById('viewAvatar').src = ev.target.result;
    };
    reader.readAsDataURL(file);
  }
});
  function switchToViewProfile() {
    document.getElementById('profileViewMode').classList.remove('hidden');
    document.getElementById('profileForm').classList.add('hidden');
  }
  // G·ª≠i form c·∫≠p nh·∫≠t th√¥ng tin c√° nh√¢n b·∫±ng fetch (AJAX)
  function showProfileNotice(message, success = true) {
  const notice = document.getElementById('profileNotice');
  notice.textContent = message;
  notice.className = 'mb-2 px-4 py-2 rounded font-semibold ' + (success ? 'bg-green-500' : 'bg-red-500');
  notice.style.display = '';
  setTimeout(() => { notice.style.display = 'none'; }, 2500);
}

function submitProfileForm(event) {
    event.preventDefault();
    const form = document.getElementById('profileForm');
    const formData = new FormData(form);

    // N·∫øu c√≥ file, th√™m v√†o formData
    const fileInput = document.getElementById('profileAvatarFile');
    if (fileInput.files.length > 0) {
      formData.append('avatar_file', fileInput.files[0]);
    }

    fetch('/profile', {
      method: 'POST',
      body: formData,
      credentials: 'same-origin'
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        userProfile.height = data.data.height;
        userProfile.weight = data.data.weight;
        userProfile.age = data.data.age;
        userProfile.gender = data.data.gender;
        userProfile.email = data.data.email;
        userProfile.bmr = data.data.bmr;
        userProfile.tdee = data.data.tdee;
        userProfile.avatar_url = data.data.avatar_url || '';
        switchToViewProfile();
        openProfileModal();
        showProfileNotice(data.message, true);
      } else {
        showProfileNotice(data.message || "C√≥ l·ªói x·∫£y ra!", false);
      }
    });
    return false;
  }
</script>
<!-- Modal Qu·∫£n l√Ω ng∆∞·ªùi d√πng (ch·ªâ admin) ƒë·∫∑t tr∆∞·ªõc </body> -->
{% if user.role == 'admin' %}
<div id="userModal" class="fixed inset-0 bg-black/40 flex items-center justify-center z-50 hidden">
  <div class="bg-white rounded-2xl shadow-2xl w-full max-w-3xl max-h-[90vh] overflow-auto p-8 flex flex-col">
    <div class="flex justify-between items-center mb-6">
      <h2 class="text-2xl font-bold text-blue-700 flex items-center gap-2">
        üë• Danh s√°ch ng∆∞·ªùi d√πng
      </h2>
      <button onclick="closeUserModal()" class="text-gray-500 hover:text-red-500 text-3xl font-bold">&times;</button>
    </div>
    <div class="overflow-y-auto max-h-[70vh] scrollbar-thin scrollbar-thumb-rounded" style="scrollbar-color: #60a5fa #f3f4f6;">
  <table class="min-w-full text-base">
        <thead class="bg-gradient-to-r from-blue-600 to-blue-400 text-white font-semibold">
          <tr>
            <th class="p-3 text-center">Avatar</th>
            <th class="p-3 text-left">T√™n</th>
            <th class="p-3 text-left">Email</th>
            <th class="p-3 text-center">Quy·ªÅn</th>
            <th class="p-3 text-center">Tr·∫°ng th√°i</th>
            <th class="p-3 text-center">H√†nh ƒë·ªông</th>
          </tr>
        </thead>
        <tbody>
          {% for u in users %}
          <tr class="even:bg-blue-50 odd:bg-white hover:bg-blue-100 transition">
            <td class="p-3 text-center">
              <img src="{{ u.avatar_url or '/static/default-avatar.png' }}" alt="Avatar" class="w-10 h-10 rounded-full border-2 border-blue-300 mx-auto shadow" />
            </td>
            <td class="p-3 font-semibold text-blue-800">{{ u.fullname }}</td>
            <td class="p-3 text-gray-700">{{ u.email }}</td>
            <td class="p-3 text-center">
              {% if u.role == 'admin' %}
                <span class="bg-yellow-200 text-yellow-800 px-2 py-1 rounded font-bold text-xs">Admin</span>
              {% else %}
                <span class="bg-green-100 text-green-700 px-2 py-1 rounded font-bold text-xs">User</span>
              {% endif %}
            </td>
            <td class="p-3 text-center">
              {% if u.is_banned %}
                <span class="bg-red-100 text-red-600 px-2 py-1 rounded font-bold text-xs">Banned</span>
              {% else %}
                <span class="bg-green-100 text-green-700 px-2 py-1 rounded font-bold text-xs">Active</span>
              {% endif %}
            </td>
            <td class="p-3 text-center">
  <div class="flex justify-center gap-3">
    {% if u.is_banned %}
      <button onclick="toggleBan('{{ u._id }}', false)" class="bg-green-500 hover:bg-green-600 text-white w-10 h-10 rounded-full flex items-center justify-center shadow transition" title="Unban">
        <span class="text-xl">üîì</span>
      </button>
    {% else %}
      <button onclick="toggleBan('{{ u._id }}', true)" class="bg-red-500 hover:bg-red-600 text-white w-10 h-10 rounded-full flex items-center justify-center shadow transition" title="Ban">
        <span class="text-xl">üîí</span>
      </button>
    {% endif %}
    {% if u._id != user._id %}
      <button onclick="toggleRole('{{ u._id }}', '{{ u.role }}')" class="bg-yellow-400 hover:bg-yellow-500 text-white w-10 h-10 rounded-full flex items-center justify-center shadow transition" title="ƒê·ªïi quy·ªÅn">
        <span class="text-xl">üîÑ</span>
      </button>
      <button onclick="confirmDeleteUser('{{ u._id }}')" class="bg-red-400 hover:bg-red-600 text-white w-10 h-10 rounded-full flex items-center justify-center shadow transition" title="X√≥a ng∆∞·ªùi d√πng">
        <span class="text-xl">üóëÔ∏è</span>
      </button>
    {% endif %}
  </div>
</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>
{% endif %}
<script>
function openUserModal() {
  document.getElementById('userModal').classList.remove('hidden');
}
function closeUserModal() {
  document.getElementById('userModal').classList.add('hidden');
}
function toggleBan(userId, ban) {
  fetch('/ban-user', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({user_id: userId, ban: ban}),
    credentials: 'same-origin'
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) {
      location.reload();
    } else {
      showNotice(data.message || "C√≥ l·ªói x·∫£y ra!");
    }
  });
}
function toggleRole(userId, currentRole) {
  const newRole = currentRole === 'admin' ? 'user' : 'admin';
  if (!confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën ƒë·ªïi quy·ªÅn th√†nh "${newRole}"?`)) return;
  fetch('/change-role', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({user_id: userId, role: newRole}),
    credentials: 'same-origin'
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) {
      location.reload();
    } else {
      showNotice(data.message || "C√≥ l·ªói x·∫£y ra!");
    }
  });
}
</script>
<!-- Modal th√¥ng b√°o ƒëƒÉng xu·∫•t -->
<div id="logoutNoticeModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-[9999] hidden">
  <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full text-center animate-fade-in">
    <div class="text-red-500 text-5xl mb-4">
      <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto w-14 h-14" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01M12 4a8 8 0 100 16 8 8 0 000-16z" />
      </svg>
    </div>
    <div id="logoutNoticeMsg" class="text-xl font-semibold text-gray-800 mb-6"></div>
    <a href="/login" class="inline-block bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-6 rounded-full shadow-lg transition duration-300 ease-in-out">
      ƒêƒÉng nh·∫≠p l·∫°i
    </a>
  </div>
</div>

<style>
@keyframes fade-in {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}
.animate-fade-in {
  animation: fade-in 0.4s ease-out;
}
</style>

<script>
function showLogoutNotice(msg) {
  document.getElementById('logoutNoticeMsg').textContent = msg;
  document.getElementById('logoutNoticeModal').classList.remove('hidden');
  setTimeout(() => {
    window.location.href = '/login';
  }, 2500);
}

function checkSession() {
  fetch('/check-session', {credentials: 'include'})
    .then(res => res.json())
    .then(data => {
      if (!data.valid) {
        let msg = '';
        if (data.reason === 'ban') msg = 'T√†i kho·∫£n c·ªßa b·∫°n ƒë√£ b·ªã kh√≥a!';
        else if (data.reason === 'other_login') msg = 'T√†i kho·∫£n ƒë√£ ƒëƒÉng nh·∫≠p ·ªü n∆°i kh√°c!';
        else msg = 'Phi√™n ƒëƒÉng nh·∫≠p ƒë√£ h·∫øt h·∫°n!';
        showLogoutNotice(msg);
      }
    });
}
setInterval(checkSession, 10000);

function toggleRole(userId, currentRole) {
  const newRole = currentRole === 'admin' ? 'user' : 'admin';
  // Xo√° d√≤ng confirm ƒë·ªÉ kh√¥ng hi·ªán popup x√°c nh·∫≠n
  fetch('/change-role', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({user_id: userId, role: newRole}),
    credentials: 'same-origin'
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) {
      showNotice("ƒê·ªïi quy·ªÅn th√†nh c√¥ng!", true);
      setTimeout(() => location.reload(), 1200);
    } else {
      showNotice(data.message || "C√≥ l·ªói x·∫£y ra!", false);
    }
  });
}
</script>
<div id="customNotice" class="fixed top-8 left-1/2 -translate-x-1/2 z-[9999] hidden px-6 py-3 rounded-xl shadow-2xl font-semibold text-white text-lg transition-all duration-300"></div>
<script>
function showNotice(msg, success=true) {
  const el = document.getElementById('customNotice');
  el.textContent = msg;
  el.className = "fixed top-8 left-1/2 -translate-x-1/2 z-[9999] px-6 py-3 rounded-xl shadow-2xl font-semibold text-lg transition-all duration-300 " + (success ? "bg-green-600" : "bg-red-600");
  el.style.display = '';
  setTimeout(() => { el.style.display = 'none'; }, 2200);
}
</script>
<!-- Modal x√°c nh·∫≠n x√≥a ng∆∞·ªùi d√πng -->
<div id="deleteUserModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-[9999] hidden">
  <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full text-center animate-fade-in">
    <div class="text-red-500 text-5xl mb-4">
      <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto w-14 h-14" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01M12 4a8 8 0 100 16 8 8 0 000-16z" />
      </svg>
    </div>
    <div class="text-xl font-semibold text-gray-800 mb-6">B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a ng∆∞·ªùi d√πng n√†y?</div>
    <div class="flex justify-center gap-4">
      <button onclick="closeDeleteUserModal()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded font-bold">H·ªßy</button>
      <button id="confirmDeleteUserBtn" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded font-bold">X√≥a</button>
    </div>
  </div>
</div>

<script>
let userIdToDelete = null;
function confirmDeleteUser(userId) {
  userIdToDelete = userId;
  document.getElementById('deleteUserModal').classList.remove('hidden');
}
function closeDeleteUserModal() {
  userIdToDelete = null;
  document.getElementById('deleteUserModal').classList.add('hidden');
}
document.getElementById('confirmDeleteUserBtn').onclick = function() {
  if (!userIdToDelete) return;
  fetch('/delete-user', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({user_id: userIdToDelete}),
    credentials: 'same-origin'
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) {
      showNotice("X√≥a ng∆∞·ªùi d√πng th√†nh c√¥ng!", true);
      setTimeout(() => location.reload(), 1200);
    } else {
      showNotice(data.message || "C√≥ l·ªói x·∫£y ra!", false);
    }
    closeDeleteUserModal();
  });
};
</script>
<style>
.scrollbar-thin::-webkit-scrollbar {
  width: 7px;
  background: #f3f4f6;
}
.scrollbar-thin::-webkit-scrollbar-thumb {
  background: #60a5fa;
  border-radius: 8px;
  min-height: 40px;
  border: 2px solid #f3f4f6;
  transition: background 0.2s;
}
.scrollbar-thin::-webkit-scrollbar-thumb:hover {
  background: #2563eb;
}
.scrollbar-thin::-webkit-scrollbar-corner {
  background: #f3f4f6;
}
.scrollbar-thumb-rounded::-webkit-scrollbar-thumb {
  border-radius: 8px;
}
#activityLogContent table,
#loginLogContent table {
  width: 100%;
  border-collapse: collapse;
  min-width: 700px;
}

#activityLogContent th,
#activityLogContent td,
#loginLogContent th,
#loginLogContent td {
  padding: 0.75rem 1rem;
  border-bottom: 1px solid #e5e7eb;
  text-align: left;
  vertical-align: middle;
  white-space: nowrap;
}
#activityLogContent th,
#loginLogContent th {
  background: linear-gradient(to right, #2563eb, #38bdf8);
  color: #fff;
  font-weight: 600;
  text-align: center;
}
#activityLogContent tr:nth-child(even),
#loginLogContent tr:nth-child(even) {
  background-color: #f1f5f9;
}
#activityLogContent tr:hover,
#loginLogContent tr:hover {
  background-color: #e0e7ef;
}
@media (max-width: 900px) {
  #activityLogContent table,
  #loginLogContent table {
    min-width: 600px;
    font-size: 0.95rem;
  }
}
@media (max-width: 700px) {
  #activityLogContent table,
  #loginLogContent table {
    min-width: 400px;
    font-size: 0.9rem;
  }
  #activityLogModal .p-8,
  #loginLogModal .p-8 {
    padding: 1rem !important;
  }
}
  #sidebar.open {
    transform: translateX(0);
  }
  #sidebarOverlay {
    display: block;
  }
  main {
    flex-direction: column;
  }
  section {
    margin-top: 0;
  }
@media (max-width: 640px) {
  .modal, .max-w-md, .max-w-2xl, .max-w-3xl {
    max-width: 98vw !important;
    padding: 0.5rem !important;
  }
  .p-6, .p-8 {  
    padding: 1rem !important;
  }
  .rounded-2xl, .rounded-xl {
    border-radius: 1rem !important;
  }
}
#sidebarOverlay.hidden {
  pointer-events: none;
  opacity: 0;
}
</style>
{% if user.role == 'admin' %}
<style>
@media (max-width: 768px) {
  #sidebar {
    position: fixed;
    top: 0;
    left: 0;
    height: 100vh;
    z-index: 50;
    width: 60vw;        
    max-width: 180px;      
    transform: translateX(-100%);
    transition: transform 0.3s;
    background: #fbc3bc;
  }
}
</style>
{% else %}
<style>
@media (max-width: 768px) {
  #sidebar {
    position: fixed;
    top: 0;
    left: 0;
    height: 100vh;
    z-index: 50;
    width: 67vw;          
    max-width: 180px;      
    transform: translateX(-100%);
    transition: transform 0.3s;
    background: #fbc3bc;
  }
}
</style>
{% endif %}
<script>
function toggleSidebar() {
  const sidebar = document.getElementById('sidebar');
  const overlay = document.getElementById('sidebarOverlay');

  const isOpen = sidebar.classList.contains('open');
  if (isOpen) {
    sidebar.classList.remove('open');
    overlay.classList.add('hidden');
  } else {
    sidebar.classList.add('open');
    overlay.classList.remove('hidden');
  }
}
// ƒê√≥ng sidebar khi ch·ªçn menu (mobile)
document.querySelectorAll('#sidebar nav button').forEach(btn => {
  btn.addEventListener('click', () => {
    if (window.innerWidth < 768) toggleSidebar();
  });
});
</script>
<!-- Modal nh·∫≠t k√Ω ho·∫°t ƒë·ªông -->
<div id="activityLogModal" class="fixed inset-0 bg-black/40 flex items-center justify-center z-50 hidden">
  <div class="bg-white rounded-2xl shadow-2xl w-full max-w-3xl max-h-[90vh] overflow-auto p-8 flex flex-col animate-fade-in">
    <div class="flex justify-between items-center mb-6">
      <h2 class="text-2xl font-bold text-blue-700 flex items-center gap-2">
        üìú Nh·∫≠t k√Ω ho·∫°t ƒë·ªông
      </h2>
      <button onclick="closeActivityLogModal()" class="text-gray-500 hover:text-red-500 text-3xl font-bold">&times;</button>
    </div>
    <div id="activityLogContent" class="text-gray-700 text-base min-h-[200px] overflow-y-auto max-h-[60vh] scrollbar-thin scrollbar-thumb-rounded" style="scrollbar-color: #60a5fa #f3f4f6;">
  <div class="flex justify-center items-center h-32 text-gray-400">ƒêang t·∫£i...</div>
</div>
  </div>
</div>
<!-- Modal nh·∫≠t k√Ω ƒëƒÉng nh·∫≠p -->
<div id="loginLogModal" class="fixed inset-0 bg-black/40 flex items-center justify-center z-50 hidden">
  <div class="bg-white rounded-2xl shadow-2xl w-full max-w-3xl max-h-[90vh] overflow-auto p-8 flex flex-col animate-fade-in">
    <div class="flex justify-between items-center mb-6">
      <h2 class="text-2xl font-bold text-green-700 flex items-center gap-2">
        üîë Nh·∫≠t k√Ω ƒëƒÉng nh·∫≠p
      </h2>
      <button onclick="closeLoginLogModal()" class="text-gray-500 hover:text-red-500 text-3xl font-bold">&times;</button>
    </div>
    <div id="loginLogContent" class="text-gray-700 text-base min-h-[200px] overflow-y-auto max-h-[60vh] scrollbar-thin scrollbar-thumb-rounded" style="scrollbar-color: #60a5fa #f3f4f6;">
  <div class="flex justify-center items-center h-32 text-gray-400">ƒêang t·∫£i...</div>
</div>
  </div>
</div>
<script>
function openActivityLogModal() {
  document.getElementById('activityLogModal').classList.remove('hidden');
  document.getElementById('activityLogContent').innerHTML = '<div class="flex justify-center items-center h-32 text-gray-400">ƒêang t·∫£i...</div>';
  fetch('/activity-log')
    .then(res => res.text())
    .then(html => { document.getElementById('activityLogContent').innerHTML = html; });
}
function closeActivityLogModal() {
  document.getElementById('activityLogModal').classList.add('hidden');
}
function openLoginLogModal() {
  document.getElementById('loginLogModal').classList.remove('hidden');
  document.getElementById('loginLogContent').innerHTML = '<div class="flex justify-center items-center h-32 text-gray-400">ƒêang t·∫£i...</div>';
  fetch('/login-log')
    .then(res => res.text())
    .then(html => { document.getElementById('loginLogContent').innerHTML = html; });
}
function closeLoginLogModal() {
  document.getElementById('loginLogModal').classList.add('hidden');
}
</script>
<!-- Modal Ho·∫°t ƒë·ªông th·ªÉ ch·∫•t & L·ªãch s·ª≠ ho·∫°t ƒë·ªông -->
<div id="activityModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 hidden transition-opacity duration-300 ease-in-out">
  <div class="bg-white p-6 rounded-2xl shadow-lg w-full max-w-md space-y-4">
    <h2 class="text-2xl font-bold text-blue-600 flex items-center gap-2">
      <span>üèÉ</span> Ghi nh·∫≠n ho·∫°t ƒë·ªông th·ªÉ ch·∫•t
    </h2>
    <form id="activityForm" class="space-y-3">
      <div>
        <label for="activityType" class="block mb-1 font-medium text-gray-700">Ch·ªçn ho·∫°t ƒë·ªông</label>
        <select name="activity" id="activityType" class="w-full border border-gray-300 p-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400 transition" required>
          <option value="">-- Ch·ªçn ho·∫°t ƒë·ªông --</option>
          <option value="walking">üö∂ ƒêi b·ªô</option>
          <option value="running">üèÉ Ch·∫°y b·ªô</option>
          <option value="cycling">üö¥ ƒê·∫°p xe</option>
          <option value="swimming">üèä B∆°i l·ªôi</option>
          <option value="yoga">üßò Yoga</option>
          <option value="weightlifting">üèãÔ∏è T·∫≠p t·∫°</option>
          <option value="jumping_rope">ü§æ Nh·∫£y d√¢y</option>
        </select>
      </div>
      <div>
        <label for="activityDuration" class="block mb-1 font-medium text-gray-700">Th·ªùi gian (ph√∫t)</label>
        <input name="duration" id="activityDuration" type="number" min="1" placeholder="Nh·∫≠p s·ªë ph√∫t" class="w-full border border-gray-300 p-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400 transition" required>
      </div>
      <div class="flex justify-end gap-3 pt-2">
        <button type="button" onclick="closeActivityModal()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded-lg font-semibold transition">Hu·ª∑</button>
        <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold transition">L∆∞u</button>
      </div>
      <div id="activityError" class="text-red-600 text-sm font-semibold"></div>
    </form>
    <div class="text-right">
      <a href="javascript:void(0)" onclick="openActivityHistoryModal()" class="text-blue-600 hover:underline text-sm">Xem l·ªãch s·ª≠ ho·∫°t ƒë·ªông &rarr;</a>
    </div>
  </div>
</div>
<div id="activityHistoryModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
  <div class="bg-white rounded-xl shadow-lg p-6 w-full max-w-2xl">
    <h2 class="text-xl font-bold mb-4">L·ªãch s·ª≠ ho·∫°t ƒë·ªông th·ªÉ ch·∫•t</h2>
    <div id="activityHistoryContent" class="max-h-96 overflow-y-auto"></div>
    <div class="flex justify-end mt-4">
      <button onclick="closeActivityHistoryModal()" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">ƒê√≥ng</button>
    </div>
  </div>
</div>
<script>
// M·ªü modal ghi nh·∫≠n ho·∫°t ƒë·ªông
function openActivityModal() {
  document.getElementById('activityModal').classList.remove('hidden');
  document.getElementById('activityForm').reset();
  document.getElementById('activityError').textContent = '';
}
// ƒê√≥ng modal ghi nh·∫≠n ho·∫°t ƒë·ªông
function closeActivityModal() {
  document.getElementById('activityModal').classList.add('hidden');
}
// X·ª≠ l√Ω submit ho·∫°t ƒë·ªông th·ªÉ ch·∫•t b·∫±ng AJAX
document.getElementById('activityForm').onsubmit = function(event) {
  event.preventDefault();
  const form = event.target;
  const data = new FormData(form);
  fetch('/activity', {
    method: 'POST',
    body: data,
    credentials: 'same-origin'
  })
  .then(res => {
    if (res.ok) return res.json();
    return res.json().then(err => { throw err; });
  })
  .then(result => {
    closeActivityModal();
    showNotice("Ghi nh·∫≠n ho·∫°t ƒë·ªông th√†nh c√¥ng!", true);
  })
  .catch(err => {
    document.getElementById('activityError').textContent = err.message || "C√≥ l·ªói x·∫£y ra!";
  });
};
window.addEventListener('resize', () => {
  const sidebar = document.getElementById('sidebar');
  const overlay = document.getElementById('sidebarOverlay');
  if (window.innerWidth >= 768) {
    sidebar.classList.remove('open');
    overlay.classList.add('hidden');
  }
});
// M·ªü modal l·ªãch s·ª≠ ho·∫°t ƒë·ªông
function openActivityHistoryModal() {
  document.getElementById('activityHistoryModal').classList.remove('hidden');
  document.getElementById('activityHistoryContent').innerHTML = '<div class="text-gray-400 text-center py-8">ƒêang t·∫£i...</div>';
fetch('/activity-history')
  .then(res => res.json())
  .then(data => {
    let html = `
      <table class="min-w-full text-sm border rounded-xl overflow-hidden shadow">
        <thead>
          <tr class="bg-blue-100 text-blue-700">
            <th class="px-4 py-2">H·ªç t√™n</th>
            <th class="px-4 py-2">Ho·∫°t ƒë·ªông</th>
            <th class="px-4 py-2">Th·ªùi gian</th>
            <th class="px-4 py-2">Calories</th>
          </tr>
        </thead>
        <tbody>
    `;
    if (data.error) {
      html += `<tr><td colspan="4" class="text-center text-red-500 py-4">${data.error}</td></tr>`;
    } else if (data.length === 0) {
      html += '<tr><td colspan="4" class="text-center text-gray-500 py-4">Ch∆∞a c√≥ ho·∫°t ƒë·ªông n√†o</td></tr>';
    } else {
      // ...existing code...
data.forEach(act => {
  let activityName = act.activity;
  if (activityName === 'jumping_rope') activityName = 'Nh·∫£y d√¢y';
  else if (activityName === 'walking') activityName = 'ƒêi b·ªô';
  else if (activityName === 'running') activityName = 'Ch·∫°y b·ªô';
  else if (activityName === 'cycling') activityName = 'ƒê·∫°p xe';
  else if (activityName === 'swimming') activityName = 'B∆°i l·ªôi';
  else if (activityName === 'yoga') activityName = 'Yoga';
  else if (activityName === 'weightlifting') activityName = 'T·∫≠p t·∫°';

  html += `<tr class="hover:bg-blue-50 transition">
    <td class="px-4 py-2">${act.fullname || ''}</td>
    <td class="px-4 py-2 capitalize">${activityName}</td>
    <td class="px-4 py-2">${act.timestamp}</td>
    <td class="px-4 py-2 font-semibold text-blue-600">${act.calories_burned} kcal</td>
  </tr>`;
});
    }
    html += '</tbody></table>';
    document.getElementById('activityHistoryContent').innerHTML = html;
  });
}
// ƒê√≥ng modal l·ªãch s·ª≠ ho·∫°t ƒë·ªông
function closeActivityHistoryModal() {
  document.getElementById('activityHistoryModal').classList.add('hidden');
}
</script>
<!-- Modal Th√¥ng tin c√° nh√¢n -->
<div id="profileModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 hidden">
  <div class="bg-white p-4 sm:p-8 rounded-xl shadow space-y-3 sm:space-y-4 w-full max-w-xs sm:max-w-md relative">
    <button onclick="closeProfileModal()" class="absolute top-2 right-3 text-2xl text-gray-400 hover:text-red-500 font-bold">&times;</button>
    <h2 class="text-2xl font-bold mb-4">Th√¥ng tin c√° nh√¢n</h2>
    <!-- Ch·∫ø ƒë·ªô ch·ªâ ƒë·ªçc -->
    <div id="profileNotice" class="hidden mb-2 px-4 py-2 rounded text-white font-semibold"></div>
    <div id="profileViewMode">
      <div class="mb-4 flex justify-center">
      <img id="viewAvatar" src="{{ user.avatar_url or '' }}" alt="Avatar" class="w-24 h-24 rounded-full border-4 border-blue-300 shadow" />
      </div>
      <div class="mb-2"><b>H·ªç t√™n:</b> <span id="viewFullname">{{ fullname }}</span></div>
      <div class="mb-2"><b>Email:</b> <span id="viewEmail">{{ user.email or "Ch∆∞a c·∫≠p nh·∫≠t" }}</span></div>
      <div class="mb-2"><b>Chi·ªÅu cao:</b> <span id="viewHeight">{{ user.height or "Ch∆∞a c·∫≠p nh·∫≠t" }}</span> cm</div>
      <div class="mb-2"><b>C√¢n n·∫∑ng:</b> <span id="viewWeight">{{ user.weight or "Ch∆∞a c·∫≠p nh·∫≠t" }}</span> kg</div>
      <div class="mb-2"><b>Tu·ªïi:</b> <span id="viewAge">{{ user.age or "Ch∆∞a c·∫≠p nh·∫≠t" }}</span></div>
      <div class="mb-2"><b>Gi·ªõi t√≠nh:</b> <span id="viewGender">
        {% if user.gender == "male" %}Nam{% elif user.gender == "female" %}N·ªØ{% else %}Ch∆∞a c·∫≠p nh·∫≠t{% endif %}
      </span></div>
      <div class="mb-2"><b>BMR:</b> <span id="viewBmr">{{ bmr if bmr else "Ch∆∞a c√≥" }}</span> kcal/ng√†y</div>
      <div class="mb-2"><b>TDEE:</b> <span id="viewTdee">{{ tdee if tdee else "Ch∆∞a c√≥" }}</span> kcal/ng√†y</div>
      <button onclick="switchToEditProfile()" class="mt-4 bg-blue-500 text-white px-4 py-2 rounded font-bold w-full">Ch·ªânh s·ª≠a</button>
    </div>
    <!-- Ch·∫ø ƒë·ªô ch·ªânh s·ª≠a -->
<form id="profileForm" method="post"
  class="space-y-2 sm:space-y-3 hidden px-1 py-2 sm:px-0 sm:py-0 max-w-xs w-full mx-auto"
  onsubmit="return submitProfileForm(event)" enctype="multipart/form-data">
  <div>
    <label class="block mb-1">Chi·ªÅu cao (cm):</label>
    <input type="number" name="height" id="profileHeight" required class="border rounded px-2 py-1 sm:px-3 sm:py-2 w-full" />
  </div>
  <div>
    <label class="block mb-1">C√¢n n·∫∑ng (kg):</label>
    <input type="number" name="weight" id="profileWeight" required class="border rounded px-2 py-1 sm:px-3 sm:py-2 w-full" />
  </div>
  <div>
    <label class="block mb-1">Tu·ªïi:</label>
    <input type="number" name="age" id="profileAge" required class="border rounded px-2 py-1 sm:px-3 sm:py-2 w-full" />
  </div>
  <div>
    <label class="block mb-1">Gi·ªõi t√≠nh:</label>
    <select name="gender" id="profileGender" required class="border rounded px-2 py-1 sm:px-3 sm:py-2 w-full">
      <option value="male">Nam</option>
      <option value="female">N·ªØ</option>
    </select>
  </div>
  <div>
    <label class="block mb-1">Email:</label>
    <input type="email" name="email" id="profileEmail" required class="border rounded px-2 py-1 sm:px-3 sm:py-2 w-full" />
  </div>
  <div>
    <label class="block mb-1">Ch·ªçn ·∫£nh ƒë·∫°i di·ªán:</label>
    <input type="file" id="profileAvatarFile" accept="image/*" class="border rounded px-2 py-1 sm:px-3 sm:py-2 w-full" />
  </div>
  <div class="flex gap-2">
    <button type="submit" class="bg-blue-500 text-white px-3 py-2 rounded font-bold w-full text-sm sm:text-base">L∆∞u</button>
    <button type="button" onclick="switchToViewProfile()" class="bg-gray-300 text-gray-800 px-3 py-2 rounded font-bold w-full text-sm sm:text-base">H·ªßy</button>
  </div>
</form>
</div>

  </body>
</html>
